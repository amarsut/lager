<!DOCTYPE html>
<html lang="sv" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jobbplanerare v14.1 - Pro</title> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Jobbplanerare v14: "Pro" --- */
        
        :root {
            /* ... (Inga ändringar här) ... */
            --primary-color: #0a84ff;
            --primary-hover: #339aff;
            --primary-light: rgba(10, 132, 255, 0.1);
            
            --success-color: #30d158;
            --warning-color: #ff9f0a;
            --danger-color: #ff453a;
            --info-color: #64d2ff;
            
            --bg-color: #f7f8fa;
            --content-bg: #ffffff;
            --border-color: #e5e7eb;
            
            --text-color: #1a1a1a;
            --text-color-light: #6b7280;
            
            --header-height: 70px;
            --border-radius: 8px;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 1px 0 rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.06), 0 2px 4px -2px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.03);
            --shadow-focus: 0 0 0 3px var(--primary-light);
            
            --transition-speed: 0.25s;
            --transition-speed-fast: 0.15s;
        }
        
        /* NY: Visuella "Pro"-justeringar för mörkt läge */
        [data-theme="dark"] {
            --bg-color: #111113; /* Mörkare, djupare bakgrund */
            --content-bg: #1A1B1E; /* Subtil nyans för innehåll */
            --border-color: #2D2E33; /* Mjukare kantlinjer */
            --text-color: #f2f2f7;
            --text-color-light: #8e8e93;
            --shadow-focus: 0 0 0 3px rgba(10, 132, 255, 0.25);
            --prio-row-bg: rgba(255, 69, 58, 0.1);
        }

        /* --- Globala stilar --- */
        /* ... (Inga ändringar här) ... */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-color-light); }
        ::-webkit-scrollbar-track { background: transparent; }

        .icon { width: 1.25rem; height: 1.25rem; }
        .icon-sm { width: 1.125rem; height: 1.125rem; }
        .icon-lg { width: 3rem; height: 3rem; opacity: 0.5; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* ... (Inga ändringar här) ... */
        .link-btn {
            background: none; border: none; padding: 0; margin: 0;
            font: inherit; color: var(--primary-color);
            text-decoration: none; cursor: pointer; font-weight: 500;
        }
        .link-btn:hover { text-decoration: underline; }
        #jobbOversikt .link-btn {
            color: var(--text-color); font-weight: 500;
        }
        #jobbOversikt .link-btn:hover {
            color: var(--primary-color); text-decoration: none;
        }
        .prio-flag-icon {
            color: var(--danger-color);
            margin-right: 0.5rem;
            vertical-align: -3px;
        }

        /* --- Layout --- */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .app-main { flex-grow: 1; overflow: auto; }
        .main-content { max-width: 1400px; margin: 0 auto; padding: 2rem; }

        /* --- Header --- */
        .main-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 1.5rem 0 2rem; height: var(--header-height);
            background-color: var(--content-bg); /* Behåll bakgrund */
            border-bottom: 1px solid var(--border-color); /* Tydligare avgränsning */
            box-shadow: var(--shadow-sm); /* Behåll en mjuk skugga */
            flex-shrink: 0; z-index: 50;
        }
        /* NY: Renare header i mörkt läge */
        [data-theme="dark"] .main-header { 
            box-shadow: none; 
            background-color: #1A1B1E; /* Samma som content-bg */
        }
        
        .header-left { display: flex; align-items: center; gap: 1rem; }
        /* ... (Inga ändringar i .nav-logo, .main-header h2) ... */
        .nav-logo {
            width: 36px; height: 36px;
            background-color: var(--primary-color); color: white;
            border-radius: 8px; display: flex; align-items: center;
            justify-content: center; font-weight: 700; font-size: 1.25rem;
            text-decoration: none; flex-shrink: 0;
            transition: all var(--transition-speed-fast) ease;
        }
        .nav-logo:hover { transform: scale(1.05); background-color: var(--primary-hover); }
        .main-header h2 { font-size: 1.5rem; font-weight: 600; margin: 0; }
        
        .header-right { display: flex; align-items: center; gap: 1rem; }
        .nav-button {
            background: transparent; border: none; color: var(--text-color-light);
            width: 44px; height: 44px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all var(--transition-speed-fast) ease;
        }
        .nav-button:hover { color: var(--primary-color); background-color: var(--bg-color); }
        
        /* NY: Aktiv knapp-styling (för Kompakt-läge) */
        .nav-button.active {
            color: var(--primary-color);
            background-color: var(--primary-light);
        }
        
        #themeToggle .icon-moon { display: none; }
        #themeToggle .icon-sun { display: block; }
        [data-theme="dark"] #themeToggle .icon-moon { display: block; }
        [data-theme="dark"] #themeToggle .icon-sun { display: none; }
        
        .divider {
            width: 1px; height: 24px;
            background-color: var(--border-color);
            margin: 0 0.5rem;
        }
        
        /* ... (Resten av .stat-bar, .stat-card, .view-controls, .search-wrapper, .button, .fabAddJob är oförändrade) ... */
        
        /* --- Tabell-design --- */
        /* ... (.table-container, .table-wrapper, #jobbOversikt är oförändrade) ... */
        
        #jobbOversikt thead {
            background-color: var(--bg-color);
            position: sticky; top: 0; z-index: 1;
        }
        /* NY: Bättre sticky header i mörkt läge */
        [data-theme="dark"] #jobbOversikt thead {
            background-color: #202125; /* Lite mörkare än content-bg för djup */
        }
        
        #jobbOversikt th, #jobbOversikt td {
            padding: 0.9rem 1.25rem;
            text-align: left; vertical-align: middle;
            white-space: nowrap;
            border-bottom: 1px solid var(--border-color);
            transition: padding var(--transition-speed-fast) ease; /* NY: Animera padding */
        }
        
        #jobbOversikt th { 
            font-size: 0.8rem; font-weight: 600; 
            color: var(--text-color-light); letter-spacing: 0.05em; 
        }
        
        #jobbOversikt tbody tr[data-id] {
            transition: background-color var(--transition-speed-fast) ease, 
                        border-left-color var(--transition-speed-fast) ease,
                        opacity var(--transition-speed) ease;
            border-left: 4px solid transparent;
            cursor: context-menu; /* ÄNDRAD: Visa högerklick */
        }
        /* NY: Justerad hover-effekt */
        [data-theme="dark"] #jobbOversikt tbody tr[data-id]:hover {
            background-color: rgba(10, 132, 255, 0.1);
        }
        
        /* ... (Resten av tabell, modal, toast, popover, kontextmeny är oförändrade) ... */
        
        /* --- NY: Kompakt Läge --- */
        .compact-mode #jobbOversikt th, 
        .compact-mode #jobbOversikt td {
            padding: 0.45rem 1rem; /* Halverad padding */
        }
        .compact-mode .status-badge {
            font-size: 0.75rem;
            padding: 0.15em 0.6em;
        }
        .compact-mode .status-badge::before {
            width: 6px; height: 6px;
        }
        
        /* --- NY: PIN-kod Modal --- */
        #pinModal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }
        .pin-content {
            background-color: var(--content-bg);
            border-radius: var(--border-radius);
            padding: 2.5rem;
            box-shadow: var(--shadow-lg);
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .pin-content h2 {
            margin: 0 0 1rem 0;
            font-weight: 600;
        }
        .pin-content p {
            margin: 0 0 1.5rem 0;
            color: var(--text-color-light);
        }
        #pinInput {
            font-family: 'Inter', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 0.25em;
            text-align: center;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            width: 150px;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin-bottom: 1rem;
        }
        #pinInput:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-focus);
        }
        #pinError {
            color: var(--danger-color);
            font-weight: 500;
            height: 1.25rem; /* Reservera utrymme */
            margin-bottom: 1rem;
        }

    </style>
</head>
<body>

            <symbol id="icon-car" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5l1.17-3.873a1.125 1.125 0 011.086-.928h10.088c.563 0 1.042.404 1.086.928l1.17 3.873m0 0H6.125M6.125 18.75L4.875 15m14.25 0l-1.25-3.75m-13.5 3.75V15m14.25 0V15M6.125 15H17.875m0 0V9a2.25 2.25 0 00-2.25-2.25H8.25A2.25 2.25 0 006 9v6z" /></symbol>
        <symbol id="icon-pencil" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></symbol>
        <symbol id="icon-list" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></symbol>
        
        <symbol id="icon-lock" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></symbol>
        <symbol id="icon-compress" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5m0 0l-3.75-3.75M16.5 16.5l3.75-3.75M7.5 20.25V7.5m0 0l3.75 3.75M7.5 7.5L3.75 11.25" /></symbol>
    </svg>

    <div class="app-container">
        
        <header class="main-header">
            <div class="header-left">
                <a href="#" class="nav-logo" title="Jobbplanerare v14.1">P</a>
                <h2>Tidslinje</h2>
            </div>
            
            <div class="header-right">
                <input type="file" id="importFile" accept=".json" style="display: none;">
                <button class="button secondary" id="importBtn" title="Importera jobb från fil">
                    <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-upload"></use></svg>
                </button>
                <button class="button secondary" id="exportBtn" title="Exportera alla jobb till fil">
                    <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-download"></use></svg>
                </button>
                
                <div class="divider"></div>
                
                <button class="nav-button" id="compactToggleBtn" title="Växla kompakt-läge">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-compress"></use></svg>
                </button>
                
                <button class="nav-button" id="themeToggle" title="Växla tema">
                    <svg class="icon icon-sun" viewBox="0 0 24 24"><use href="#icon-sun"></use></svg>
                    <svg class="icon icon-moon" viewBox="0 0 24 24"><use href="#icon-moon"></use></svg>
                </button>
                
                <button class="nav-button" id="lockAppBtn" title="Lås appen">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-lock"></use></svg>
                </button>
                
                <button class="button clear-filter" id="clearDayFilterBtn" style="display: none;">
                    &times; Rensa sökning
                </button>
            </div>
        </header>

        <main class="app-main">
            <div class="main-content">
                
                <div class="stat-bar" id="statBar">
                    <div class="stat-card clickable" id="stat-card-kommande" data-filter="kommande">
                        <h3 class="stat-card-title"><svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-briefcase"></use></svg><span>Kommande jobb</span></h3>
                        <p class="stat-card-value" id="stat-upcoming">0</p>
                    </div>
                    <div class="stat-card success clickable" id="stat-card-klar" data-filter="klar">
                        <h3 class="stat-card-title"><svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-check"></use></svg><span>Färdiga jobb</span></h3>
                        <p class="stat-card-value" id="stat-finished">0</p>
                    </div>
                    <div class="stat-card info clickable" id="stat-card-offererad" data-filter="offererad">
                        <h3 class="stat-card-title"><svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-file-text"></use></svg><span>Offererade</span></h3>
                        <p class="stat-card-value" id="stat-offered">0</p>
                    </div>
                    <div class="stat-card default clickable" id="stat-card-alla" data-filter="alla">
                        <h3 class="stat-card-title"><svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-list"></use></svg><span>Alla jobb</span></h3>
                        <p class="stat-card-value" id="stat-all">0</p>
                    </div>
                </div>
                
                <div class="view-controls">
                    <div class="search-wrapper">
                        <svg class="icon" viewBox="0 0 24 24"><use href="#icon-search"></use></svg>
                        <input type="search" id="searchBar" placeholder="Sök jobb... (F)">
                    </div>
                </div>
                
                <div class="table-container" id="jobListContainer">
                <div class="empty-state" id="emptyStateTimeline">
                    <svg class="icon-lg" viewBox="0 0 24 24"><use href="#icon-empty"></use></svg>
                    <h3 id="emptyStateTitleTimeline">Du har inga jobb</h3>
                    <p id="emptyStateTextTimeline">Klicka på "+" för att börja.</p>
                    <button class="button primary" id="emptyStateAddBtn">
                        <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-plus"></use></svg>
                        <span>Lägg till nytt jobb</span>
                    </button>
                </div>

            </div>
        </main>
    </div>

    <button id="fabAddJob" title="Lägg till nytt jobb (N)">
        <svg class="icon" viewBox="0 0 24 24"><use href="#icon-plus"></use></svg>
    </button>
    
    <div id="jobModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Lägg till nytt jobb</h2>
                <button class="modal-close-btn" id="modalCloseBtn" aria-label="Stäng modal">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-close"></use></svg>
                </button>
            </div>
            
            <form id="jobModalForm" class="modal-body">
                <input type="hidden" id="jobId">
                
                <div class="form-group-split">
                    <div class="form-group"><label for="status">Status</label>
                        <select id="status" required>
                            <option value="offererad">Offererad</option>
                            <option value="bokad" selected>Bokad</option>
                            <option value="klar">Klar</option>
                            <option value="avbokad">Avbokad</option>
                        </select>
                    </div>
                    <div class="form-group-inline">
                        <label for="prio">Hög Prioritet</label>
                        <input type="checkbox" id="prio">
                    </div>
                </div>

                <div class="form-group"><label for="kundnamn">Kundens Namn</label><input type="text" id="kundnamn" placeholder="Eva Svensson" required></div>
                <div class="form-group"><label for="telefon">Telefon</label><input type="tel" id="telefon" placeholder="070-123 45 67"></div>
                <div class="form-group"><label for="regnr">Registreringsnummer</label><input type="text" id="regnr" placeholder="ABC 123"></div>

                <div class="form-group-split">
                    <div class="form-group"><label for="kundpris">Kundpris (kr)</label><input type="number" id="kundpris" value="0" min="0" required></div>
                    <div class="form-group"><label for="utgifter">Utgifter (kr)</label><input type="number" id="utgifter" value="0" min="0" required></div>
                </div>
                
                <div class="form-group-profit">
                    <span id="vinstKalkyl">Vinst: 0 kr</span>
                </div>
                
                <div class="form-group-split">
                    <div class="form-group">
                        <label for="datum">Datum</label>
                        <input type="date" id="datum" required>
                        <svg class="icon-sm input-icon" viewBox="0 0 24 24"><use href="#icon-calendar-day"></use></svg>
                        <button type="button" class="today-btn" id="setTodayBtn">Idag</button>
                    </div>
                    <div class="form-group">
                        <label for="tid">Tid</label>
                        <input type="time" id="tid" required>
                        <svg class="icon-sm input-icon" viewBox="0 0 24 24"><use href="#icon-clock"></use></svg>
                    </div>
                </div>

                <div class="form-group full-width"><label for="kommentarer">Offerter / Övriga kommentarer</label><textarea id="kommentarer" rows="4"></textarea></div>
                
            </form>
            <div class="modal-actions">
                <button type="button" class="button secondary" id="modalCancelBtn">Avbryt</button>
                <button type="button" class="button secondary" id="modalDuplicateBtn">
                    <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-duplicate"></use></svg>
                    <span>Duplicera</span>
                </button>
                <button type="submit" class="button primary" id="modalSaveBtn" form="jobModalForm">Spara Jobb</button>
            </div>
        </div>
    </div>
    
    <div id="customerModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header detail-modal-header" id="customerModalHeader">
                <h2 id="customerModalName"></h2>
                <p id="customerModalPhone"></p>
                <button class="modal-close-btn" id="customerModalCloseBtn" aria-label="Stäng modal">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-close"></use></svg>
                </button>
            </div>
            
            <div class="detail-stats">
                <div>
                    <span class="stat-title">Total Vinst</span>
                    <span class="stat-value" id="customerModalTotalProfit"></span>
                </div>
                <div>
                    <span class="stat-title">Antal Jobb</span>
                    <span class="stat-value" id="customerModalJobCount"></span>
                </div>
            </div>
            
            <div class="modal-body">
                <ul class="detail-job-list" id="customerModalJobList">
                    </ul>
            </div>
        </div>
    </div>
    
    <div id="carModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header detail-modal-header" id="carModalHeader">
                <h2 id="carModalRegnr"></h2>
                <p id="carModalOwner"></p>
                <button class="modal-close-btn" id="carModalCloseBtn" aria-label="Stäng modal">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-close"></use></svg>
                </button>
            </div>
            
            <div class="detail-stats">
                <div>
                    <span class="stat-title">Total Vinst</span>
                    <span class="stat-value" id="carModalTotalProfit"></span>
                </div>
                <div>
                    <span class="stat-title">Antal Jobb</span>
                    <span class="stat-value" id="carModalJobCount"></span>
                </div>
            </div>
            
            <div class="modal-body">
                <ul class="detail-job-list" id="carModalJobList">
                    </ul>
            </div>
        </div>
    </div>
    
    <div id="popoverBackdrop" class="popover-backdrop"></div>
    <div id="commentPopover">
        <div id="commentPopoverHeader">
            <h4>Anteckningar</h4>
            <button id="commentPopoverClose" class="icon-btn">
                <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-close"></use></svg>
            </button>
        </div>
        <div id="commentPopoverContent">
            </div>
    </div>
    
    <div id="contextMenu">
        </div>
    
    <div id="toastNotification" class="toast"></div>

    <div id="pinModal" style="display: none;"> <div class="pin-content">
            <h2><svg class="icon" viewBox="0 0 24 24" style="vertical-align: -3px; margin-right: 0.5rem;"><use href="#icon-lock"></use></svg> Låst</h2>
            <p>Ange PIN-kod för att fortsätta</p>
            <form id="pinForm">
                <input type="password" id="pinInput" maxlength="4" inputmode="numeric">
                <div id="pinError"></div>
                <button type="submit" class="button primary">Lås upp</button>
            </form>
        </div>
    </div>


    <script>
        // --- GLOBALA KONSTANTER (v14.1) ---
        const STATUS_TEXT = {
            'bokad': 'Bokad', 'klar': 'Klar', 
            'offererad': 'Offererad', 'avbokad': 'Avbokad'
        };
        const formatCurrency = (num) => `${num.toLocaleString('sv-SE')} kr`;
        
        // NY: PIN-konstanter
        const CORRECT_PIN = '0912';
        const PIN_SESSION_KEY = 'jobbplanerare_pin_session_active';
        
        const formatDate = (dateString) => {
            // ... (Oförändrad) ...
            if (!dateString) return 'Okänt datum';
            try {
                const d = new Date(dateString);
                const datePart = d.toLocaleDateString('sv-SE', { month: 'short', day: 'numeric' });
                const h = String(d.getHours()).padStart(2, '0');
                const m = String(d.getMinutes()).padStart(2, '0');
                return `${datePart} kl. ${h}.${m}`;
            } catch (e) {
                console.error("Ogiltigt datumformat:", dateString);
                return "Ogiltigt datum";
            }
        };
        
        const debounce = (func, timeout = 300) => {
            // ... (Oförändrad) ...
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        };
        
        function highlightSearchTerm(text, term) {
            // ... (Oförändrad) ...
            if (!term) return text;
            const safeText = String(text).replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const regex = new RegExp(`(${term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
            return safeText.replace(regex, '<mark>$1</mark>');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- NY: PIN-kods-check (körs FÖRST) ---
            const pinModal = document.getElementById('pinModal');
            const pinForm = document.getElementById('pinForm');
            const pinInput = document.getElementById('pinInput');
            const pinError = document.getElementById('pinError');
            
            function checkPin(e) {
                e.preventDefault();
                if (pinInput.value === CORRECT_PIN) {
                    sessionStorage.setItem(PIN_SESSION_KEY, 'true');
                    pinModal.style.opacity = '0';
                    setTimeout(() => pinModal.style.display = 'none', 300);
                    // Fokuserar på sökfältet efter upplåsning
                    document.getElementById('searchBar').focus(); 
                } else {
                    pinError.textContent = 'Fel PIN-kod';
                    pinInput.value = '';
                    pinInput.focus();
                    // Skaka-animation vid fel
                    pinModal.classList.add('shake');
                    setTimeout(() => pinModal.classList.remove('shake'), 500);
                }
            }

            if (sessionStorage.getItem(PIN_SESSION_KEY) !== 'true') {
                pinModal.style.display = 'flex';
                setTimeout(() => pinModal.style.opacity = '1', 10);
                pinInput.focus();
                pinForm.addEventListener('submit', checkPin);
                // Stoppa resten av app-initieringen tills upplåst
                return; 
            }
            // --- Slut på PIN-kods-check ---
            
            // Om vi kommer hit är vi redan upplåsta, kör resten av appen
            initializeApp();
        });

        // NY: Hela app-initieringen är inkapslad
        function initializeApp() {
            
            // --- Globalt Tillstånd (State) ---
            let allJobs = [];
            let currentSearchTerm = "";
            let currentStatusFilter = 'kommande'; // 'kommande', 'klar', 'offererad', 'alla'
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];

            // --- DOM-element ---
            const docElement = document.documentElement;
            const appBody = document.body; // NY: För kompakt-läge
            
            // Tidslinje-vy
            const jobListContainer = document.getElementById('jobListContainer');
            const emptyStateTimeline = document.getElementById('emptyStateTimeline');
            const emptyStateTitleTimeline = document.getElementById('emptyStateTitleTimeline');
            const emptyStateTextTimeline = document.getElementById('emptyStateTextTimeline');
            const emptyStateAddBtn = document.getElementById('emptyStateAddBtn');
            
            // Header-kontroller
            const searchBar = document.getElementById('searchBar');
            const clearDayFilterBtn = document.getElementById('clearDayFilterBtn');
            const themeToggle = document.getElementById('themeToggle');
            const toast = document.getElementById('toastNotification');
            const compactToggleBtn = document.getElementById('compactToggleBtn'); // NY
            const lockAppBtn = document.getElementById('lockAppBtn'); // NY
            
            // ... (Resten av DOM-elementen är oförändrade) ...
            const statBar = document.getElementById('statBar');
            const statUpcoming = document.getElementById('stat-upcoming');
            const statFinished = document.getElementById('stat-finished');
            const statOffered = document.getElementById('stat-offered');
            const statAll = document.getElementById('stat-all');
            const importBtn = document.getElementById('importBtn');
            const exportBtn = document.getElementById('exportBtn');
            const importFile = document.getElementById('importFile');
            
            // Jobb-Modal
            const jobModal = document.getElementById('jobModal');
            const jobModalForm = document.getElementById('jobModalForm');
            const modalTitle = document.getElementById('modalTitle');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            const modalDuplicateBtn = document.getElementById('modalDuplicateBtn');
            const fabAddJob = document.getElementById('fabAddJob');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            
            // Jobb-Modal Fält
            const modalJobId = document.getElementById('jobId');
            const modalKundpris = document.getElementById('kundpris');
            const modalUtgifter = document.getElementById('utgifter');
            const modalVinstKalkyl = document.getElementById('vinstKalkyl');
            const modalRegnr = document.getElementById('regnr');
            const modalDatum = document.getElementById('datum');
            const modalTid = document.getElementById('tid');
            const modalKundnamn = document.getElementById('kundnamn');
            const modalTelefon = document.getElementById('telefon');
            const setTodayBtn = document.getElementById('setTodayBtn');
            
            // Kund-Modal
            const customerModal = document.getElementById('customerModal');
            const customerModalCloseBtn = document.getElementById('customerModalCloseBtn');
            const customerModalName = document.getElementById('customerModalName');
            const customerModalPhone = document.getElementById('customerModalPhone');
            const customerModalTotalProfit = document.getElementById('customerModalTotalProfit');
            const customerModalJobCount = document.getElementById('customerModalJobCount');
            const customerModalJobList = document.getElementById('customerModalJobList');
            
            // Bil-Modal (NY)
            const carModal = document.getElementById('carModal');
            const carModalCloseBtn = document.getElementById('carModalCloseBtn');
            const carModalRegnr = document.getElementById('carModalRegnr');
            const carModalOwner = document.getElementById('carModalOwner');
            const carModalTotalProfit = document.getElementById('carModalTotalProfit');
            const carModalJobCount = document.getElementById('carModalJobCount');
            const carModalJobList = document.getElementById('carModalJobList');
            
            // Comment Popover
            const popoverBackdrop = document.getElementById('popoverBackdrop');
            const commentPopover = document.getElementById('commentPopover');
            const commentPopoverContent = document.getElementById('commentPopoverContent');
            const commentPopoverClose = document.getElementById('commentPopoverClose');
            
            // Kontextmeny (NY)
            const contextMenu = document.getElementById('contextMenu');
            let contextMenuJobId = null;

            // --- Notifikation (Toast) ---
            let toastTimer;
            function showToast(message, type = 'success') {
                // ... (Oförändrad) ...
                clearTimeout(toastTimer);
                toast.textContent = message;
                toast.className = `toast show ${type}`;
                toastTimer = setTimeout(() => { toast.className = 'toast'; }, 3000);
            }
            
            // --- Huvud-renderingsfunktion ---
            function renderApp() {
                loadJobsFromStorage();
                
                let jobsToDisplay = [...allJobs];
                
                // 1. Filtrera på Status (från stat-korten)
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                
                switch(currentStatusFilter) {
                    // ... (Oförändrad) ...
                    case 'kommande':
                        jobsToDisplay = jobsToDisplay.filter(j => 
                            j.status === 'bokad' && new Date(j.datum) >= now
                        );
                        break;
                    case 'klar':
                        jobsToDisplay = jobsToDisplay.filter(j => j.status === 'klar');
                        break;
                    case 'offererad':
                        jobsToDisplay = jobsToDisplay.filter(j => j.status === 'offererad');
                        break;
                    case 'alla':
                        // Inget statusfilter
                        break;
                }
                
                // 2. Filtrera på Sökterm
                if (currentSearchTerm) {
                    // ... (Oförändrad) ...
                    jobsToDisplay = jobsToDisplay.filter(job => {
                        const term = currentSearchTerm.toLowerCase();
                        return (
                            job.kundnamn.toLowerCase().includes(term) ||
                            (job.regnr && job.regnr.toLowerCase().includes(term)) ||
                            (job.kommentarer && job.kommentarer.toLowerCase().includes(term)) ||
                            (job.telefon && job.telefon.includes(term)) ||
                            (STATUS_TEXT[job.status] || '').toLowerCase().includes(term)
                        );
                    });
                }
                
                renderGlobalStats(allJobs);
                
                // 3. Rendera tabellen
                const timelineCount = renderTimelineTable(jobsToDisplay);
                
                // 4. Hantera "Tom vy" ELLER visa listan
                // NY: Korrigerad logik för att visa/dölja listan
                if (timelineCount === 0) {
                    // Det finns inga jobb, visa "Tom vy"
                    jobListContainer.style.display = 'none';
                    emptyStateTimeline.classList.add('show');
                    
                    if (currentSearchTerm) {
                        emptyStateTitleTimeline.textContent = "Inga träffar";
                        emptyStateTextTimeline.textContent = `Din sökning på "${currentSearchTerm}" gav inga resultat.`;
                    } else {
                        const filterText = document.querySelector(`.stat-card[data-filter="${currentStatusFilter}"] h3`).textContent;
                        emptyStateTitleTimeline.textContent = `Inga ${filterText.toLowerCase()}`;
                        emptyStateTextTimeline.textContent = "Klicka på '+' för att lägga till ett nytt jobb.";
                    }
                } else {
                    // Det finns jobb, visa listan!
                    jobListContainer.style.display = 'block';
                    emptyStateTimeline.classList.remove('show');
                }
            }
            
            // Statistik-funktion (Uppdaterad)
            function renderGlobalStats(jobs) {
                // ... (Oförändrad) ...
                const now = new Date();
                now.setHours(0, 0, 0, 0);

                const upcomingJobs = jobs.filter(j => j.status === 'bokad' && new Date(j.datum) >= now).length;
                const finishedJobs = jobs.filter(j => j.status === 'klar').length;
                const offeredJobs = jobs.filter(j => j.status === 'offererad').length;
                const allJobCount = jobs.length;
                
                statUpcoming.textContent = upcomingJobs;
                statFinished.textContent = finishedJobs;
                statOffered.textContent = offeredJobs;
                statAll.textContent = allJobCount;
                
                // Markera aktivt filter-kort
                document.querySelectorAll('.stat-card.active').forEach(c => c.classList.remove('active'));
                const activeCard = document.getElementById(`stat-card-${currentStatusFilter}`);
                if (activeCard) {
                    activeCard.classList.add('active');
                }
            }

            // --- Renderingsfunktioner (Tidslinje) ---

            function renderTimelineTable(jobs) {
                // ... (Oförändrad) ...
                jobListContainer.innerHTML = '';
                
                let jobsToRender = [...jobs];
                
                // Sortering (finns kvar, bara filtreringen som flyttats)
                jobsToRender.sort((a, b) => {
                    if (a.prio && !b.prio) return -1;
                    if (!a.prio && b.prio) return 1;
                    return new Date(a.datum) - new Date(b.datum);
                });

                if (jobsToRender.length === 0) { return 0; }

                let tableHTML = `
                    <div class="table-wrapper">
                        <table id="jobbOversikt">
                            ${createTableHead()}
                            <tbody>
                                ${jobsToRender.map(job => createJobRow(job)).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                jobListContainer.innerHTML = tableHTML;
                return jobsToRender.length;
            }

            // NY: Ändrad tabell-header (Vinst borttagen)
            function createTableHead() {
                return `
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Datum</th>
                            <th>Kund</th>
                            <th>Reg.nr</th>
                            <th>Kundpris</th>
                            <th class="action-col">Åtgärder</th>
                        </tr>
                    </thead>
                `;
            }

            // NY: Ändrad tabell-rad (Vinst borttagen)
            function createJobRow(job) {
                // const vinstClass = job.vinst > 0 ? 'positive' : (job.vinst < 0 ? 'negative' : ''); // Behövs ej
                const prioClass = job.prio ? 'prio-row' : '';
                const doneClass = (job.status === 'klar') ? 'done-row' : '';
                
                const prioIcon = job.prio ? `<svg class="icon-sm prio-flag-icon" viewBox="0 0 24 24"><use href="#icon-flag"></use></svg>` : '';
                
                const hasComment = job.kommentarer && job.kommentarer.trim().length > 0;
                const kundnamnHTML = highlightSearchTerm(job.kundnamn, currentSearchTerm);
                const regnrHTML = highlightSearchTerm(job.regnr || '---', currentSearchTerm);
                
                return `
                    <tr data-id="${job.id}" data-status="${job.status}" class="${prioClass} ${doneClass}">
                        <td><span class="status-badge status-${job.status || 'bokad'}">${STATUS_TEXT[job.status] || 'Bokad'}</span></td>
                        <td>${formatDate(job.datum)}</td>
                        <td>
                            ${prioIcon}
                            <button class="link-btn customer-link" data-kund="${job.kundnamn}">
                                ${kundnamnHTML}
                            </button>
                        </td>
                        <td>
                            <button class="link-btn car-link" data-regnr="${job.regnr}">
                                ${regnrHTML}
                            </button>
                        </td>
                        <td>${formatCurrency(job.kundpris)}</td>
                        
                        <td class="action-col">
                            ${hasComment ? `
                            <button class="icon-btn comment-btn" data-comment="${encodeURIComponent(job.kommentarer)}" title="Visa kommentar" aria-label="Visa kommentar">
                                <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-chat"></use></svg>
                            </button>
                            ` : `<span style="width: 40px;"></span>`}
                            <button class="icon-btn delete-btn" data-id="${job.id}" title="Ta bort" aria-label="Ta bort jobb">
                                <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-trash"></use></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }

            // --- Datahantering & Lagring ---
            function migrateData() { /* ... (Oförändrad) ... */ }
            function loadJobsFromStorage() { /* ... (Oförändrad) ... */ }
            function saveJobsToStorage() { /* ... (Oförändrad) ... */ }
            function getDemoData() { /* ... (Oförändrad) ... */ }
            
            // --- Comment Popover-hantering ---
            function showCommentPopover(button) { /* ... (Oförändrad) ... */ }
            function hideCommentPopover() { /* ... (Oförändrad) ... */ }

            // --- Jobb-Modal-hantering ---
            function updateLiveProfit() { /* ... (Oförändrad) ... */ }
            function openModal(mode, dataToClone = null) { /* ... (Oförändrad) ... */ }
            function closeModal() { /* ... (Oförändrad) ... */ }
            function getJobDataFromForm() { /* ... (Oförändrad) ... */ }
            
            // --- NY: Bil- & Kund-Modal-hantering ---
            function openCustomerModal(kundnamn) { /* ... (Oförändrad) ... */ }
            function closeCustomerModal() { /* ... (Oförändrad) ... */ }
            function openCarModal(regnr) { /* ... (Oförändrad) ... */ }
            function closeCarModal() { /* ... (Oförändrad) ... */ }
            
            // --- NY: Kontextmeny-hantering ---
            function showContextMenu(e, jobId) { /* ... (Oförändrad) ... */ }
            function hideContextMenu() { /* ... (Oförändrad) ... */ }
            
            // --- NY: Åtgärdsfunktioner (från Kontextmeny) ---
            function findJob(jobId) { /* ... (Oförändrad) ... */ }
            function deleteJob(jobId) { /* ... (Oförändrad) ... */ }
            function togglePrio(jobId) { /* ... (Oförändrad) ... */ }
            function duplicateJob(jobId) { /* ... (Oförändrad) ... */ }

            // --- Event Handlers ---
            
            function handleFormSubmit(e) { /* ... (Oförändrad) ... */ }
            
            // Event delegation för Tidslinje-listan
            jobListContainer.addEventListener('click', (e) => { /* ... (Oförändrad) ... */ });
            
            // NY: Kontextmeny-listener
            jobListContainer.addEventListener('contextmenu', (e) => { /* ... (Oförändrad) ... */ });
            
            // NY: Hantera klick på kontextmeny
            contextMenu.addEventListener('click', (e) => { /* ... (Oförändrad) ... */ });
            
            // NY: Stäng menyer vid klick utanför
            window.addEventListener('click', () => { /* ... (Oförändrad) ... */ });
            
            popoverBackdrop.addEventListener('click', hideCommentPopover);
            commentPopoverClose.addEventListener('click', hideCommentPopover);

            // Sökfält
            searchBar.addEventListener('input', debounce((e) => { /* ... (Oförändrad) ... */ }));
            clearDayFilterBtn.addEventListener('click', () => { /* ... (Oförändrad) ... */ });
            
            // Filter-hanterare (NY)
            statBar.addEventListener('click', (e) => { /* ... (Oförändrad) ... */ });
            
            // Jobb-Modal-events
            jobModalForm.addEventListener('submit', handleFormSubmit);
            fabAddJob.addEventListener('click', () => openModal('add'));
            emptyStateAddBtn.addEventListener('click', () => openModal('add'));
            modalCloseBtn.addEventListener('click', closeModal);
            modalCancelBtn.addEventListener('click', closeModal);
            jobModal.addEventListener('click', (e) => { /* ... (Oförändrad) ... */ });
            modalDuplicateBtn.addEventListener('click', () => { /* ... (Oförändrad) ... */ });
            modalKundpris.addEventListener('input', updateLiveProfit);
            modalUtgifter.addEventListener('input', updateLiveProfit);
            modalRegnr.addEventListener('input', debounce((e) => { /* ... (Oförändrad) ... */ }, 500));
            modalKundnamn.addEventListener('change', (e) => { /* ... (Oförändrad) ... */ });
            setTodayBtn.addEventListener('click', () => { /* ... (Oförändrad) ... */ });

            // Kund-Modal-events
            customerModalCloseBtn.addEventListener('click', closeCustomerModal);
            customerModal.addEventListener('click', (e) => { /* ... (Oförändrad) ... */ });
            
            // Bil-Modal-events (NY)
            carModalCloseBtn.addEventListener('click', closeCarModal);
            carModal.addEventListener('click', (e) => { /* ... (Oförändrad) ... */ });

            // Tema-hantering
            themeToggle.addEventListener('click', () => { /* ... (Oförändrad) ... */ });
            function setTheme(theme) { /* ... (Oförändrad) ... */ }
            
            // NY: Kompakt-läge hantering
            function setCompactMode(isCompact) {
                if (isCompact) {
                    appBody.classList.add('compact-mode');
                    compactToggleBtn.classList.add('active');
                    localStorage.setItem('compactMode', 'true');
                } else {
                    appBody.classList.remove('compact-mode');
                    compactToggleBtn.classList.remove('active');
                    localStorage.setItem('compactMode', 'false');
                }
            }
            
            compactToggleBtn.addEventListener('click', () => {
                const isCurrentlyCompact = appBody.classList.contains('compact-mode');
                setCompactMode(!isCurrentlyCompact);
            });
            
            // NY: Lås-app hantering
            lockAppBtn.addEventListener('click', () => {
                sessionStorage.removeItem(PIN_SESSION_KEY);
                location.reload();
            });

            // Import/Export Handlers
            exportBtn.addEventListener('click', () => { /* ... (Oförändrad) ... */ });
            importBtn.addEventListener('click', () => { /* ... (Oförändrad) ... */ });
            importFile.addEventListener('change', (e) => { /* ... (Oförändrad) ... */ });

            // Tangentbordsgenvägar
            document.addEventListener('keydown', (e) => { /* ... (Oförändrad) ... */ });

            // --- Initialisering ---
            migrateData();
            
            // Läs in tema-inställning
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);
            
            // NY: Läs in kompakt-läge-inställning
            const savedCompactMode = localStorage.getItem('compactMode') === 'true';
            setCompactMode(savedCompactMode);

            // Starta appen
            renderApp();
        } // --- Slut på initializeApp() ---
    </script>

</body>
</html>
