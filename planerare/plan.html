<!DOCTYPE html>
<html lang="sv" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jobbplanerare v15 - Kalender</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

	<link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

</head>
<body>

    <svg width="0" height="0" style="position:absolute;display:none;">
        <symbol id="icon-user" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A1.875 1.875 0 0117.624 22H6.376a1.875 1.875 0 01-1.875-1.882z" /></symbol>
        
        <symbol id="icon-logo-p" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.35 3.836c-1.061 1.061-1.66 2.503-1.66 4.025 0 3.223 2.612 5.836 5.836 5.836 1.522 0 2.964-.598 4.025-1.66m-8.05 3.32a6.963 6.963 0 00-4.025 1.66C6.446 18.06 5.845 19.502 5.845 21H3.75c0-3.223 2.612-5.836 5.836-5.836 1.522 0 2.964.598 4.025 1.66m8.05-3.32a6.963 6.963 0 00-4.025-1.66c-1.061-1.061-2.503-1.66-4.025-1.66-3.223 0-5.836 2.612-5.836 5.836 0 1.522.598 2.964 1.66 4.025m3.32-8.05a6.963 6.963 0 001.66-4.025C13.664 6.446 15.106 5.845 16.628 5.845c3.223 0 5.836 2.612 5.836 5.836 0 1.522-.598 2.964-1.66 4.025" /></symbol>
        <symbol id="icon-plus" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></symbol>
        <symbol id="icon-trash" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.578 0a48.108 48.108 0 01-3.478-.397m15.42 0A48.1 48.1 0 0012 5.11M4.772 5.79L4.772 4.102a2.25 2.25 0 012.25-2.25h1.5a2.25 2.25 0 012.25 2.25v1.688M4.772 5.79l-.175 2.457a1.125 1.125 0 001.12 1.228H18.28a1.125 1.125 0 001.12-1.228l-.175-2.457m0 0l-1.096-1.547a.562.562 0 00-.923 0l-1.096 1.547M19.228 5.79l-1.096-1.547a.562.562 0 01-.923 0l-1.096 1.547" /></symbol>
        <symbol id="icon-empty" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></symbol>
        <symbol id="icon-search" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></symbol>
        <symbol id="icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12H.75m.386-6.364l1.591 1.591M12 12a4.5 4.5 0 100-9 4.5 4.5 0 000 9z" /></symbol>
        <symbol id="icon-moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></symbol>
        <symbol id="icon-close" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></symbol>
        <symbol id="icon-chat" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.068.157 2.148.279 3.238.364.466.037.893.281 1.153.671L12 21l3.66-3.938c.26-.29.687-.534 1.153-.67 1.09-.086 2.17-.208 3.238-.365 1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.344 48.344 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.74v6.02z" /></symbol>
        <symbol id="icon-calendar-day" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3.75 8.25h16.5M4.5 1.5h15A2.25 2.25 0 0121.75 3.75v16.5A2.25 2.25 0 0119.5 22.5h-15A2.25 2.25 0 012.25 20.25V3.75A2.25 2.25 0 014.5 1.5zM12 12.75h.007v.008H12v-.008z" /></symbol>
        <symbol id="icon-clock" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></symbol>
        <symbol id="icon-duplicate" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75c-.621 0-1.125-.504-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375V17.25" /></symbol>
        <symbol id="icon-upload" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></symbol>
        <symbol id="icon-download" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></symbol>
        <symbol id="icon-briefcase" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.05a2.25 2.25 0 01-2.25 2.25H5.002a2.25 2.25 0 01-2.25-2.25v-4.05m17.25-8.25v8.25m0 0H4.75m15.5 0v-8.25a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v8.25" /></symbol>
        <symbol id="icon-file-text" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75v-2.625a3.375 3.375 0 013.375-3.375h1.5A1.125 1.125 0 0013.5 7.125v-1.5a3.375 3.375 0 013.375-3.375H15.75m-7.5 12.75h-1.5a3.375 3.375 0 01-3.375-3.375V8.625a3.375 3.375 0 013.375-3.375h1.5A3.375 3.375 0 0113.5 8.625v2.625a3.375 3.375 0 01-3.375 3.375M15 12h-1.5" /></symbol>
        <symbol id="icon-check" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></symbol>
        <symbol id="icon-flag" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0l2.77-.693a9 9 0 016.208.682l.108.054a9 9 0 006.086.71l3.114-.732a48.524 48.524 0 01-.005-10.499l-3.11.732a9 9 0 01-6.085-.711l-.108-.054a9 9 0 00-6.208-.682L3 4.5M3 15V4.5" /></symbol>
        <symbol id="icon-phone" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-2.827-1.45-5.154-3.777-6.604-6.604l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" /></symbol>
        <symbol id="icon-car" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5l1.17-3.873a1.125 1.125 0 011.086-.928h10.088c.563 0 1.042.404 1.086.928l1.17 3.873m0 0H6.125M6.125 18.75L4.875 15m14.25 0l-1.25-3.75m-13.5 3.75V15m14.25 0V15M6.125 15H17.875m0 0V9a2.25 2.25 0 00-2.25-2.25H8.25A2.25 2.25 0 006 9v6z" /></symbol>
        <symbol id="icon-pencil" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></symbol>
        <symbol id="icon-list" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></symbol>
        <symbol id="icon-lock-closed" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></symbol>
        <symbol id="icon-view-dense" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 6h18M3 10h18M3 14h18M3 18h18" /></symbol>
        
        <symbol id="icon-calendar-view" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3.75 8.25h16.5M3.75 12h16.5M3.75 15.75h16.5M4.5 1.5h15A2.25 2.25 0 0121.75 3.75v16.5A2.25 2.25 0 0119.5 22.5h-15A2.25 2.25 0 012.25 20.25V3.75A2.25 2.25 0 014.5 1.5z" /></symbol>
        <symbol id="icon-timeline-view" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5M3.75 17.25h16.5" /></symbol>

        <symbol id="icon-settings" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.242 1.417l-1.07 1.07a.999.999 0 000 1.414l1.07 1.07c.418.418.418 1.099 0 1.517l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456a1.125 1.125 0 00-1.075.124c-.073.044-.146.087-.22.127a1.125 1.125 0 00-.645.87l-.213 1.281c-.09.542-.56.94-1.11.94h-2.593c-.55 0-1.02-.398-1.11-.94l-.213-1.281a1.125 1.125 0 00-.645-.87c-.074-.04-.147-.083-.22-.127a1.125 1.125 0 00-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.242-1.417l1.07-1.07a.999.999 0 000-1.414l-1.07-1.07a1.125 1.125 0 010-1.517l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456a1.125 1.125 0 001.075-.124c.073-.044.146-.087.22-.127.332-.183.582-.496.645-.87l.213-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></symbol>
        <symbol id="icon-external-link" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></symbol>
        <symbol id="icon-oil" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.25 8.25h-.01M12.75 8.25h.01M10.25 8.25h.01M7.75 8.25h.01M7.75 10.75h.01M10.25 10.75h.01M12.75 10.75h.01M15.25 10.75h.01M7.75 13.25h.01M10.25 13.25h.01M12.75 13.25h.01M15.25 13.25h.01M4.871 1.754l1.106-1.04a1.125 1.125 0 011.532 0l1.106 1.04m-3.744 0a48.611 48.611 0 003.744 0M4.871 1.754A48.611 48.611 0 018.615 1.754m-3.744 0l.006.006m3.732 0l.006.006m.006.006l.006-.006m-3.744 0l.006.006M15.75 5.25h1.5a1.5 1.5 0 011.5 1.5v8.25a1.5 1.5 0 01-1.5 1.5h-1.5m0-11.25S13.5 5.25 12 5.25s-3.75 0-3.75 0m0 11.25h-1.5a1.5 1.5 0 01-1.5-1.5V6.75a1.5 1.5 0 011.5-1.5h1.5m0 11.25S10.5 16.5 12 16.5s3.75 0 3.75 0" /></symbol>
        <symbol id="icon-tire" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.91 15.91a4.5 4.5 0 01-6.364 0 4.5 4.5 0 010-6.364 4.5 4.5 0 016.364 0zm-1.06-1.06a3 3 0 00-4.242 0 3 3 0 000 4.242 3 3 0 004.242 0 3 3 0 000-4.242z" /></symbol>
        <symbol id="icon-clipboard" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></symbol>
        <symbol id="icon-wallet" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9A2.25 2.25 0 0018.75 6.75H5.25A2.25 2.25 0 003 9v3m18 0a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 12m15.375-3.862A2.25 2.25 0 0118.75 6.75H5.25A2.25 2.25 0 013 9v3m15.375-3.862A2.25 2.25 0 0018.75 9H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6" /></symbol>
    
    </svg>

    <div class="app-container">
        
        <header class="main-header">
            <div class="header-left">
                <a href="#" class="nav-logo" title="Statistiköversikt">
			    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			        <path d="M8 7H5a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3"/>
			        <path d="M16 2v6h-4V2h4zM12 11h.01"/>
			        <path d="M12 15h.01"/>
			        <path d="M12 19h.01"/>
			    </svg>
				</a>
                <div class="header-titles">
                    <span class="app-brand-title" id="appBrandTitle"></span>
                    <div class="view-toggle-buttons" id="viewToggleButtons">
                        <button class="button-toggle-view active" id="btnToggleTimeline" data-view="timeline">
                            <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-timeline-view"></use></svg>
                            <span>Tidslinje</span>
                        </button>
                        <button class="button-toggle-view" id="btnToggleCalendar" data-view="calendar">
                            <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-calendar-view"></use></svg>
                            <span>Kalender</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="header-right">
                <div class="header-profit-display" id="headerProfitDisplay" style="display: none;">
                    <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-wallet"></use></svg>
                    <span>Dagens Vinst:</span>
                    <span id="headerProfitValue">0 kr</span>
                </div>

                <div class="divider"></div>

                <button class="nav-button" id="settingsBtn" title="Inställningar">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-settings"></use></svg>
                </button>
                
                <button class="nav-button" id="toggleCompactView" title="Kompakt vy">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-view-dense"></use></svg>
                </button>
                <button class="nav-button" id="lockAppBtn" title="Lås appen">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-lock-closed"></use></svg>
                </button>
                <button class="nav-button" id="themeToggle" title="Växla tema">
                    <svg class="icon icon-sun" viewBox="0 0 24 24"><use href="#icon-sun"></use></svg>
                    <svg class="icon icon-moon" viewBox="0 0 24 24"><use href="#icon-moon"></use></svg>
                </button>
                
                <button class="button clear-filter" id="clearDayFilterBtn" style="display: none;">
                    &times; Rensa sökning
                </button>
            </div>
        </header>

        <main class="app-main">
            <div class="main-content">
                
                <div class="stat-bar" id="statBar">
                    <div class="stat-card clickable" id="stat-card-kommande" data-filter="kommande">
                        <h3 class="stat-card-title"><svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-briefcase"></use></svg><span>Kommande jobb</span></h3>
                        <p class="stat-card-value" id="stat-upcoming">0</p>
                    </div>
                    <div class="stat-card success clickable" id="stat-card-klar" data-filter="klar">
                        <h3 class="stat-card-title"><svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-check"></use></svg><span>Färdiga jobb</span></h3>
                        <p class="stat-card-value" id="stat-finished">0</p>
                    </div>
                    <div class="stat-card info clickable" id="stat-card-offererad" data-filter="offererad">
                        <h3 class="stat-card-title"><svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-file-text"></use></svg><span>Offererade</span></h3>
                        <p class="stat-card-value" id="stat-offered">0</p>
                    </div>
                    <div class="stat-card default clickable" id="stat-card-alla" data-filter="alla">
                        <h3 class="stat-card-title"><svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-list"></use></svg><span>Alla jobb</span></h3>
                        <p class="stat-card-value" id="stat-all">0</p>
                    </div>
                </div>
                
                <div id="timelineView">
                    <div class="view-controls" id="view-controls">
                        <div class="search-wrapper">
                            <svg class="icon icon-search" viewBox="0 0 24 24"><use href="#icon-search"></use></svg>
                            
                            <div class="search-spinner"></div> 
                            
                            <input type="search" id="searchBar" placeholder="Sök jobb... (F)">
                            
                            <button type="button" class="search-clear-btn" id="desktopSearchClear" title="Rensa sökning"></button>
                        </div>
                    </div>

                    <div class="table-container" id="jobListContainer">
                        </div>
                    <div class="empty-state" id="emptyStateTimeline">
                        <svg class="icon-lg" viewBox="0 0 24 24"><use href="#icon-empty"></use></svg>
                        <h3 id="emptyStateTitleTimeline">Laddar jobb från molnet...</h3>
                        <p id="emptyStateTextTimeline">Om detta tar tid, se till att du klistrat in din Firebase Config.</p>
                        <button class="button primary" id="emptyStateAddBtn">
                            <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-plus"></use></svg>
                            <span>Lägg till nytt jobb</span>
                        </button>
                    </div>
                </div>

                <div id="calendarView" style="display: none;">
                    <div id="calendarContainer"></div>
                </div>

            </div>
        </main>
    </div>

    <nav class="mobile-nav" id="mobileNav">
        <button class="mobile-nav-btn active" data-view="timeline">
            <svg class="icon" viewBox="0 0 24 24"><use href="#icon-timeline-view"></use></svg>
            <span>Tidslinje</span>
        </button>
        <button class="mobile-nav-btn" data-view="calendar">
            <svg class="icon" viewBox="0 0 24 24"><use href="#icon-calendar-view"></use></svg>
            <span>Kalender</span>
        </button>
        <button class="mobile-nav-btn" id="mobileAddJobBtn" data-modal="jobModal">
            <svg class="icon" viewBox="0 0 24 24"><use href="#icon-plus"></use></svg>
            <span>Nytt Jobb</span>
        </button>
        <button class="mobile-nav-btn" id="mobileSearchBtn" data-modal="mobileSearchModal">
            <svg class="icon" viewBox="0 0 24 24"><use href="#icon-search"></use></svg>
            <span>Sök</span>
        </button>
        <button class="mobile-nav-btn" id="mobileSettingsBtn" data-modal="settingsModal">
            <svg class="icon" viewBox="0 0 24 24"><use href="#icon-settings"></use></svg>
            <span>Mer</span>
        </button>
    </nav>
    
    <div id="mobileSearchModal" class="modal-backdrop-mobile" data-modal-id="mobileSearchModal">
        <div class="search-modal-content">
            <form id="mobileSearchForm" style="display: contents;">
                <div class="search-wrapper">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-search"></use></svg>
                    <input type="search" id="mobileSearchBar" placeholder="Sök jobb...">
                    
                    <button type="button" class="search-clear-btn" id="mobileSearchClear" title="Rensa sökning"></button>
                </div>
            </form>
            <button id="mobileSearchCloseBtn" class="button secondary">Avbryt</button>
        </div>
    </div>


    <button id="fabAddJob" title="Lägg till nytt jobb (N)">
        <svg class="icon" viewBox="0 0 24 24"><use href="#icon-plus"></use></svg>
    </button>

    <div id="jobModal" class="modal-backdrop" data-modal-id="jobModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Lägg till nytt jobb</h2>
                
                <button class="modal-close-btn" id="modalCloseBtn" aria-label="Stäng modal">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-close"></use></svg>
                </button>
            </div>
            
            <form id="jobModalForm" class="modal-body">
                <input type="hidden" id="jobId">

                <div class="job-templates" id="jobTemplates">
                    <button type="button" class="button template-btn" data-template="oljebyte">
                        <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-oil"></use></svg>
                        <span>Oljebyte</span>
                    </button>
                    <button type="button" class="button template-btn" data-template="hjulskifte">
                        <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-tire"></use></svg>
                        <span>Hjulskifte</span>
                    </button>
                    
                    <label class="prio-toggle-wrapper" for="prio" id="prioToggleWrapper">
                        <input type="checkbox" id="prio">
                        <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-flag"></use></svg>
                        <span>Prioritet</span>
                    </label>
                </div>
                
                <div class="form-group full-width">
                    <label for="status">Status</label>
                    <div class="quick-status-buttons" id="quickStatusButtons">
                        <button type="button" class="button" data-status="offererad">Offererad</button>
                        <button type="button" class="button" data-status="bokad">Bokad</button>
                        <button type="button" class="button" data-status="klar">Klar</button>
                        <button type="button" class="button" data-status="avbokad">Avbokad</button>
                    </div>
                    <select id="status" required class="visually-hidden">
                        <option value="offererad">Offererad</option>
                        <option value="bokad" selected>Bokad</option>
                        <option value="klar">Klar</option>
                        <option value="avbokad">Avbokad</option>
                    </select>
                </div>

                <div class="form-group full-width form-group-copyable">
                    <label for="kundnamn">Kundens Namn</label>
                    <input type="text" id="kundnamn" placeholder="Eva Svensson" required autocomplete="off">
                    <button type="button" class="copy-btn" id="copyKundnamn" title="Kopiera Kundnamn">
                        <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-clipboard"></use></svg>
                    </button>
                    <div id="kundnamnSuggestions" class="suggestions-list"></div>
                </div>

                <div class="form-group full-width">
                    <label for="telefon">Telefonnummer</label>
                    <input type="tel" id="telefon" placeholder="070-123 45 67" autocomplete="off">
                </div>
                
                <div class="form-group-split">
                    <div class="form-group form-group-copyable">
                        <label for="regnr">Registreringsnummer</label>
                        <input type="text" id="regnr" placeholder="ABC 123">
                        <button type="button" class="copy-btn" id="copyRegnr" title="Kopiera Reg.nr">
                            <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-clipboard"></use></svg>
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="matarstallning">Mätarställning (km)</label>
                        <input type="text" inputmode="numeric" id="matarstallning" placeholder="t.ex. 123456" class="input-reminder">
                    </div>
                </div>
                
                <div class="form-group-split">
                    <div class="form-group">
                        <label for="kundpris">Kundpris (kr)</label>
                        <input type="number" id="kundpris" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="utgifter">Utgifter (kr)</label>
                        <input type="number" id="utgifter" value="0" min="0" required>
                    </div>
                </div>
                
                <div class="form-group-profit">
                    <span id="vinstKalkyl">Vinst: 0 kr</span>
                </div>
                
                <div class="form-group-split">
                    <div class="form-group">
                        <label for="datum">Datum</label>
                        <div class="input-wrapper">
                            <input type="date" id="datum" required>
                            <svg class="icon-sm input-icon" viewBox="0 0 24 24"><use href="#icon-calendar-day"></use></svg>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="tid">Tid</label>
                        <div class="input-wrapper">
                            <input type="time" id="tid" required>
                            <svg class="icon-sm input-icon" viewBox="0 0 24 24"><use href="#icon-clock"></use></svg>
                        </div>
                        
                        <div class="quick-time-buttons" id="quickTimeButtons">
                            <button type="button" data-time="09:00">09:00</button>
                            <button type="button" data-time="10:00">10:00</button>
                            <button type="button" data-time="12:00">12:00</button>
                            <button type="button" data-time="14:00">14:00</button>
                            <button type="button" data-time="16:30">16:30</button>
                            <button type="button" data-time="18:00">18:00</button>
                        </div>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="kommentarer">Offerter / Övriga kommentarer</label>
                    <textarea id="kommentarer" rows="4"></textarea>
                </div>
                
            </form>
			
            <div class="modal-actions">
                <button type="button" class="button secondary" id="modalCancelBtn">Avbryt</button>
                <button type="submit" class="button primary" id="modalSaveBtn" form="jobModalForm">Spara</button>
            </div>
        </div>
    </div>
    
    <div id="customerModal" class="modal-backdrop" data-modal-id="customerModal">
        <div class="modal-content">
            <div class="modal-header detail-modal-header" id="customerModalHeader">
                <h2 id="customerModalName"></h2>
                <div class="customer-phone-wrapper">
                    <p id="customerModalPhone"></p>
                    <button class="icon-btn" id="editCustomerPhoneBtn" title="Redigera telefonnummer">
                        <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-pencil"></use></svg>
                    </button>
                </div>
                <button class="modal-close-btn" id="customerModalCloseBtn" aria-label="Stäng modal">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-close"></use></svg>
                </button>
            </div>
            
            <div class="detail-stats">
                <div>
                    <span class="stat-title">Total Vinst</span>
                    <span class="stat-value" id="customerModalTotalProfit"></span>
                </div>
                <div>
                    <span class="stat-title">Antal Jobb</span>
                    <span class="stat-value" id="customerModalJobCount"></span>
                </div>
            </div>
            
            <div class="modal-body">
                <div class="search-wrapper">
                    <svg class="icon icon-search" viewBox="0 0 24 24"><use href="#icon-search"></use></svg>
                    <input type="search" id="customerSearch" placeholder="Filtrera jobb...">
                </div>
                <ul class="detail-job-list" id="customerModalJobList">
                    </ul>
            </div>
        </div>
    </div>
    
    <div id="carModal" class="modal-backdrop" data-modal-id="carModal">
        <div class="modal-content">
            <div class="modal-header detail-modal-header" id="carModalHeader">
                <div class="modal-title-with-link">
                    <h2 id="carModalRegnr"></h2>
                    <a id="carModalExternalLink" href="#" target="_blank" rel="noopener noreferrer" title="Öppna i Biluppgifter.se">
                        <img src="https://biluppgifter.se/favicon/favicon.ico" alt="Biluppgifter Ikon" />
                    </a>
                </div>
                <p id="carModalOwner"></p>
                <button class="modal-close-btn" id="carModalCloseBtn" aria-label="Stäng modal">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-close"></use></svg>
                </button>
            </div>
            
            <div class="detail-stats">
                <div>
                    <span class="stat-title">Total Vinst</span>
                    <span class="stat-value" id="carModalTotalProfit"></span>
                </div>
                <div>
                    <span class="stat-title">Antal Jobb</span>
                    <span class="stat-value" id="carModalJobCount"></span>
                </div>
            </div>
            
            <div class="modal-body">
                <div class="search-wrapper">
                    <svg class="icon icon-search" viewBox="0 0 24 24"><use href="#icon-search"></use></svg>
                    <input type="search" id="carSearch" placeholder="Filtrera jobb...">
                </div>
                <ul class="detail-job-list" id="carModalJobList">
                </ul>

                <a id="carModalExternalLinkMobile" href="#" target="_blank" rel="noopener noreferrer" class="button">
                    <img src="https://biluppgifter.se/favicon/favicon.ico" alt="Biluppgifter Ikon" />
                    <span>Öppna i Biluppgifter.se</span>
                </a>
            </div>
        </div>
    </div>

	<div id="statsModal" class="modal-backdrop" data-modal-id="statsModal">
        <div class="modal-content">
            <div class="modal-header detail-modal-header">
                <h2>Statistiköversikt</h2>
                <p>Baserat på alla "Klar"-markerade jobb.</p>
                <button class="modal-close-btn" id="statsModalCloseBtn" aria-label="Stäng modal">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-close"></use></svg>
                </button>
            </div>
            
            <div class="detail-stats" id="statsModalSummary">
                <div>
                    <span class="stat-title">Total Vinst</span>
                    <span class="stat-value" id="statsModalTotalProfit">0 kr</span>
                </div>
                <div>
                    <span class="stat-title">Totalt Antal Jobb</span>
                    <span class="stat-value" id="statsModalJobCount">0</span>
                </div>
            </div>
            
            <div class="modal-body" id="statsModalBody">
                
                <div class="profit-goal-progress" id="profitGoalProgress" style="display: none;">
                    <div class="progress-bar-text">
                        <span class="current" id="profitGoalCurrent">0 kr</span>
                        <span class="goal" id="profitGoalTarget">Mål: 0 kr</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="profitGoalFill"></div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="statsChart"></canvas>
                </div>
                
                <h3 class="chart-title">Aktivitet per Veckodag</h3>
                <div class="chart-container" style="max-height: 220px;">
                    <canvas id="weekdayChart"></canvas>
                </div>

                </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-backdrop" data-modal-id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Mer & Inställningar</h2>
                <button class="modal-close-btn" id="settingsModalCloseBtn" aria-label="Stäng modal">
                    <svg class="icon" viewBox="0 0 24 24"><use href="#icon-close"></use></svg>
                </button>
            </div>
            
            <form id="settingsModalForm" class="modal-body">
                <div class="form-group">
                    <label for="profitGoalInput">Månadsmål Vinst (kr)</label>
                    <input type="number" id="profitGoalInput" placeholder="t.ex. 50000" min="0">
                    <p style="font-size: 0.8rem; color: var(--text-color-light); margin-top: 0.5rem;">
                        Sätt ett vinstmål för innevarande månad. Visas i statistik-översikten.
                    </p>
                </div>

                <div class="form-group">
                    <label>Standardvy vid Start</label>
                    <div class="settings-radio-group">
                        <input type="radio" id="defaultViewTimeline" name="defaultView" value="timeline" checked>
                        <label for="defaultViewTimeline">
                            <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-timeline-view"></use></svg>
                            <span>Tidslinje</span>
                        </label>
                        
                        <input type="radio" id="defaultViewCalendar" name="defaultView" value="calendar">
                        <label for="defaultViewCalendar">
                            <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-calendar-view"></use></svg>
                            <span>Kalender</span>
                        </label>
                    </div>
                </div>

                <div class="form-group settings-button-group" id="mobileSettingsGroup">
                    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 0.5rem 0;">
                    <label>App-åtgärder</label>
                    <button type="button" class="button secondary" id="settingsThemeToggle">
                        <svg class="icon icon-sun" viewBox="0 0 24 24"><use href="#icon-sun"></use></svg>
                        <svg class="icon icon-moon" viewBox="0 0 24 24"><use href="#icon-moon"></use></svg>
                        <span>Växla Tema</span>
                    </button>
                    <button type="button" class="button secondary" id="settingsToggleCompactView">
                        <svg class="icon" viewBox="0 0 24 24"><use href="#icon-view-dense"></use></svg>
                        <span>Kompakt Vy</span>
                    </button>
                    <button type="button" class="button secondary" id="settingsLockAppBtn">
                        <svg class="icon" viewBox="0 0 24 24"><use href="#icon-lock-closed"></use></svg>
                        <span>Lås Appen</span>
                    </button>
                </div>

                <div class="form-group settings-button-group">
                    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 0.5rem 0;">
                    <label>Data</label>
                    <button type="button" class="button secondary csv-export" id="exportCsvBtn">
                        <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-download"></use></svg>
                        <span>Exportera alla jobb till CSV</span>
                    </button>
                </div>

            </form>
			
            <div class="modal-actions">
                <button type="button" class="button secondary" id="settingsModalCancelBtn">Avbryt</button>
                <button type="submit" class="button primary" id="settingsModalSaveBtn" form="settingsModalForm">Spara</button>
            </div>
        </div>
    </div>
    
    <div id="popoverBackdrop" class="popover-backdrop"></div>
    <div id="commentPopover">
        <div id="commentPopoverHeader">
            <h4>Anteckningar</h4>
            <button id="commentPopoverClose" class="icon-btn">
                <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-close"></use></svg>
            </button>
        </div>
        <div id="commentPopoverContent">
            </div>
    </div>
    
    <div id="contextMenu">
        </div>
    
    <div id="toastNotification" class="toast"></div>

    <div id="pinLockModal" class="modal-backdrop" data-modal-id="pinLockModal">
        <div class="pin-lock-container">
            <a href="#" class="nav-logo" style="margin: 0 auto 1.5rem auto;">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			        <path d="M8 7H5a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3"/>
			        <path d="M16 2v6h-4V2h4zM12 11h.01"/>
			        <path d="M12 15h.01"/>
			        <path d="M12 19h.01"/>
			    </svg>
            </a>
            <h2>Ange PIN-kod</h2>
            <p>Ange din 4-siffriga PIN för att låsa upp.</p>
            <form id="pinLockForm">
                <input type="password" id="pinInput" maxlength="4" pattern="[0-9]*" inputmode="numeric" autocomplete="one-time-code" required>
                <p id="pinError"></p>
                <button type="submit" class="button primary" id="pinUnlockBtn" form="pinLockForm">Lås upp</button>
            </form>
        </div>
    </div>

    <script>
        // --- Firebase Config (Oförändrad) ---
        const firebaseConfig = {
		  apiKey: "AIzaSyDwCQkUl-je3L3kF7EuxRC6Dm6Gw2N0nJw",
		  authDomain: "planerare-f6006.firebaseapp.com",
		  projectId: "planerare-f6006",
		  storageBucket: "planerare-f6006.firebasestorage.app",
		  messagingSenderId: "360462069749",
		  appId: "1:360462069749:web:c754879f3f75d5ef3cbabc",
		  measurementId: "G-L6516XLZ1Y"
		};

		// --- REGISTRERA SERVICE WORKER FÖR PWA INSTALLATION ---
		if ('serviceWorker' in navigator) {
		    window.addEventListener('load', () => {
		        navigator.serviceWorker.register('./sw.js')
		            .then(registration => {
		                console.log('Service Worker registrerad framgångsrikt med scope:', registration.scope);
		            })
		            .catch(error => {
		                console.log('Service Worker registrering misslyckades:', error);
		            });
		    });
		}

        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase initierat!");
        } catch (e) {
            console.error("Kunde inte initiera Firebase.", e);
            alert("Kunde inte initiera Firebase.");
        }
        
        // --- Globala Konstanter ---
        const STATUS_TEXT = {
            'bokad': 'Bokad', 'klar': 'Klar', 
            'offererad': 'Offererad', 'avbokad': 'Avbokad'
        };
        const formatCurrency = (num) => `${(num || 0).toLocaleString('sv-SE')} kr`;
        const locale = 'sv-SE';
        
        const formatDate = (dateString, options = {}) => {
            const { onlyDate = false } = options;
            if (!dateString) return 'Okänt datum';
            try {
                const d = new Date(dateString);
                
                const dateOptions = { weekday: 'short', month: 'short', day: 'numeric' };
                const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };
                
                let datePart = new Intl.DateTimeFormat(locale, dateOptions).format(d);
                datePart = datePart.charAt(0).toUpperCase() + datePart.slice(1); 
                
                if (onlyDate) {
                    return datePart;
                }
                
                const timePart = new Intl.DateTimeFormat(locale, timeOptions).format(d).replace(':', '.');
                
                return `${datePart} kl. ${timePart}`;

            } catch (e) { return "Ogiltigt datum"; }
        };
        
        const debounce = (func, timeout = 300) => {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        };
        function highlightSearchTerm(text, term) {
            if (!term) return text;
            const safeText = String(text).replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const regex = new RegExp(`(${term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
            return safeText.replace(regex, '<mark>$1</mark>');
        }

        // --- NYTT: Kontextuell Ikon-funktion ---
        function getJobContextIcon(job) {
            const kommentarer = job.kommentarer ? job.kommentarer.toLowerCase() : '';
            
            if (kommentarer.includes('olja') || kommentarer.includes('oljebyte')) {
                return `<svg class="context-icon" viewBox="0 0 24 24"><use href="#icon-oil"></use></svg>`;
            }
            if (kommentarer.includes('däck') || kommentarer.includes('hjul') || kommentarer.includes('hjulskifte')) {
                return `<svg class="context-icon" viewBox="0 0 24 24"><use href="#icon-tire"></use></svg>`;
            }
            // Du kan lägga till fler "else if" här för andra ikoner (t.ex. bromsar, service etc.)
            
            return ''; // Returnera tom sträng om inget matchar
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- Globalt Tillstånd (State) ---
            let allJobs = [];
            let currentSearchTerm = "";
            let currentStatusFilter = 'kommande';
            let appInitialized = false;
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            
            let calendar;
            let currentView = localStorage.getItem('defaultView') || 'timeline';
            
            let isModalOpen = false;
            let currentOpenModalId = null;
            let isNavigatingBack = false; 

            let statsChartInstance = null;
            let weekdayChartInstance = null;
            let currentProfitGoal = localStorage.getItem('profitGoal') || 0; 

            // --- DOM-element ---
            const docElement = document.documentElement;
            const appContainer = document.querySelector('.app-container');
            const toast = document.getElementById('toastNotification');
            
            const appBrandTitle = document.getElementById('appBrandTitle'); 
            const headerProfitDisplay = document.getElementById('headerProfitDisplay');
            const headerProfitValue = document.getElementById('headerProfitValue');
            
            const timelineView = document.getElementById('timelineView');
            const jobListContainer = document.getElementById('jobListContainer');
            const emptyStateTimeline = document.getElementById('emptyStateTimeline');
            const emptyStateTitleTimeline = document.getElementById('emptyStateTitleTimeline');
            const emptyStateTextTimeline = document.getElementById('emptyStateTextTimeline');
            const emptyStateAddBtn = document.getElementById('emptyStateAddBtn');
            const searchBar = document.getElementById('searchBar');
            const viewControls = document.getElementById('view-controls');
			const desktopSearchWrapper = document.querySelector('#view-controls .search-wrapper');
            const clearDayFilterBtn = document.getElementById('clearDayFilterBtn');

            const calendarView = document.getElementById('calendarView');
            const calendarContainer = document.getElementById('calendarContainer');
            const viewToggleButtons = document.getElementById('viewToggleButtons');
            const btnToggleTimeline = document.getElementById('btnToggleTimeline');
            const btnToggleCalendar = document.getElementById('btnToggleCalendar');
            
            const themeToggle = document.getElementById('themeToggle');
            const statBar = document.getElementById('statBar');
            const statUpcoming = document.getElementById('stat-upcoming');
            const statFinished = document.getElementById('stat-finished');
            const statOffered = document.getElementById('stat-offered');
            const statAll = document.getElementById('stat-all');
            
            const jobModal = document.getElementById('jobModal');
            const jobModalForm = document.getElementById('jobModalForm');
            const modalTitle = document.getElementById('modalTitle');
            const modalSaveBtn = document.getElementById('modalSaveBtn');
            const jobTemplates = document.getElementById('jobTemplates'); 
            const fabAddJob = document.getElementById('fabAddJob');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            const modalJobId = document.getElementById('jobId');
            const modalKundpris = document.getElementById('kundpris');
            const modalUtgifter = document.getElementById('utgifter');
            const modalVinstKalkyl = document.getElementById('vinstKalkyl');
            const modalRegnr = document.getElementById('regnr');
            const modalDatum = document.getElementById('datum');
            const modalTid = document.getElementById('tid');
            const quickTimeButtons = document.getElementById('quickTimeButtons');
            const modalKundnamn = document.getElementById('kundnamn');
            const kundnamnSuggestions = document.getElementById('kundnamnSuggestions');
            const modalTelefon = document.getElementById('telefon');
            const modalStatusSelect = document.getElementById('status');
            const quickStatusButtons = document.getElementById('quickStatusButtons');
            const copyKundnamnBtn = document.getElementById('copyKundnamn');
            const copyRegnrBtn = document.getElementById('copyRegnr');
            
            const customerModal = document.getElementById('customerModal');
            const customerModalCloseBtn = document.getElementById('customerModalCloseBtn');
            const customerModalName = document.getElementById('customerModalName');
            const customerModalPhone = document.getElementById('customerModalPhone');
            const editCustomerPhoneBtn = document.getElementById('editCustomerPhoneBtn'); 
            const customerModalTotalProfit = document.getElementById('customerModalTotalProfit');
            const customerModalJobCount = document.getElementById('customerModalJobCount');
            const customerModalJobList = document.getElementById('customerModalJobList');
            const customerSearch = document.getElementById('customerSearch'); 
            
            const carModal = document.getElementById('carModal');
            const carModalCloseBtn = document.getElementById('carModalCloseBtn');
            const carModalRegnr = document.getElementById('carModalRegnr');
            const carModalOwner = document.getElementById('carModalOwner');
            const carModalExternalLink = document.getElementById('carModalExternalLink'); 
            const carModalExternalLinkMobile = document.getElementById('carModalExternalLinkMobile'); 
            const carModalTotalProfit = document.getElementById('carModalTotalProfit');
            const carModalJobCount = document.getElementById('carModalJobCount');
            const carModalJobList = document.getElementById('carModalJobList');
            const carSearch = document.getElementById('carSearch'); 

            const navLogo = document.querySelector('.nav-logo');
            const statsModal = document.getElementById('statsModal');
            const statsModalCloseBtn = document.getElementById('statsModalCloseBtn');
            const statsModalTotalProfit = document.getElementById('statsModalTotalProfit');
            const statsModalJobCount = document.getElementById('statsModalJobCount');
            const statsModalBody = document.getElementById('statsModalBody');
            
            const settingsBtn = document.getElementById('settingsBtn');
            const mobileSettingsBtn = document.getElementById('mobileSettingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const settingsModalCloseBtn = document.getElementById('settingsModalCloseBtn');
            const settingsModalCancelBtn = document.getElementById('settingsModalCancelBtn');
            const settingsModalSaveBtn = document.getElementById('settingsModalSaveBtn');
            const settingsModalForm = document.getElementById('settingsModalForm');
            const profitGoalInput = document.getElementById('profitGoalInput');
            const profitGoalProgress = document.getElementById('profitGoalProgress');
            const profitGoalCurrent = document.getElementById('profitGoalCurrent');
            const profitGoalTarget = document.getElementById('profitGoalTarget');
            const profitGoalFill = document.getElementById('profitGoalFill');
            const mobileSettingsGroup = document.getElementById('mobileSettingsGroup');
            const settingsThemeToggle = document.getElementById('settingsThemeToggle');
            const settingsToggleCompactView = document.getElementById('settingsToggleCompactView');
            const settingsLockAppBtn = document.getElementById('settingsLockAppBtn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');


            const popoverBackdrop = document.getElementById('popoverBackdrop');
            const commentPopover = document.getElementById('commentPopover');
            const commentPopoverContent = document.getElementById('commentPopoverContent');
            const commentPopoverClose = document.getElementById('commentPopoverClose');

			commentPopover.addEventListener('click', (e) => e.stopPropagation());
            
            const contextMenu = document.getElementById('contextMenu');
            let contextMenuJobId = null;
            
            const toggleCompactView = document.getElementById('toggleCompactView');
            
            const pinLockModal = document.getElementById('pinLockModal');
            const pinLockForm = document.getElementById('pinLockForm');
            const pinInput = document.getElementById('pinInput');
            const pinError = document.getElementById('pinError');
            const lockAppBtn = document.getElementById('lockAppBtn');
            const APP_PIN_KEY = 'jobbPlannerarePin';
            const PIN_LAST_UNLOCKED_KEY = 'jobbPlannerareLastUnlocked';

            // Mobila DOM-element
            const mobileNav = document.getElementById('mobileNav');
            const mobileAddJobBtn = document.getElementById('mobileAddJobBtn');
            const mobileSearchBtn = document.getElementById('mobileSearchBtn');
            const mobileSearchModal = document.getElementById('mobileSearchModal');
            const mobileSearchForm = document.getElementById('mobileSearchForm'); 
            const mobileSearchBar = document.getElementById('mobileSearchBar');
            const mobileSearchCloseBtn = document.getElementById('mobileSearchCloseBtn');

            const desktopSearchClear = document.getElementById('desktopSearchClear');
            const mobileSearchClear = document.getElementById('mobileSearchClear');

            // --- Toast-funktion med "Ångra" ---
            let toastTimer;
            function showToast(message, type = 'success', undoCallback = null) {
                clearTimeout(toastTimer);
                
                toast.innerHTML = ''; 
                
                const textSpan = document.createElement('span');
                textSpan.textContent = message;
                toast.appendChild(textSpan);

                toast.className = `toast show ${type}`;
                
                let duration = 3000;

                if (undoCallback) {
                    duration = 5000; 
                    const undoButton = document.createElement('button');
                    undoButton.className = 'button secondary'; 
                    undoButton.textContent = 'Ångra';
                    
                    undoButton.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        undoCallback(); 
                        toast.className = 'toast'; 
                        clearTimeout(toastTimer);
                    });
                    
                    toast.appendChild(undoButton);
                }

                toastTimer = setTimeout(() => { 
                    toast.className = 'toast'; 
                }, duration);
            }
            
            // --- Kalender-funktioner ---
            function initializeCalendar() {
                calendar = new FullCalendar.Calendar(calendarContainer, {
                    initialView: 'dayGridTwoWeek', 
                    locale: 'sv',
                    firstDay: 1, 
                    height: 'auto', 
                    
                    headerToolbar: { 
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridTwoWeek,timeGridWeek,timeGridDay'
                    },
                    buttonText: {
                        today:         'Idag',
                        dayGridTwoWeek:'14 Dagar',
                        timeGridWeek:  'Vecka',
                        timeGridDay:   'Dag',
                        listWeek:      'Vecka' 
                    },
                    
                    views: {
                        dayGridTwoWeek: {
                            type: 'dayGrid',
                            duration: { weeks: 2 },
                            displayEventTime: true,
                            dayCellContent: function(arg) {
                                let dayNumberEl = document.createElement('a');
                                dayNumberEl.classList.add('fc-daygrid-day-number');
                                dayNumberEl.innerText = arg.dayNumberText;

                                let profitEl = document.createElement('div');
                                profitEl.classList.add('calendar-day-profit');
                                profitEl.setAttribute('data-date', arg.date.toISOString().split('T')[0]);

                                return { domNodes: [dayNumberEl, profitEl] };
                            }
                        },
                        timeGridWeek: {
                            displayEventTime: true
                        },
                        timeGridDay: {
                            displayEventTime: true
                        },
                        listWeek: {
                            type: 'list',
                            duration: { weeks: 1 },
                            listDayFormat: false, 
                            listDaySideFormat: false,
                            noEventsText: 'Inga jobb denna vecka'
                        }
                    },
                    
                    editable: true,
                    selectable: true,
                    slotMinTime: '07:00:00',
                    slotMaxTime: '21:00:00',
                    allDaySlot: false,
                    
                    eventClick: (clickInfo) => {
                        const jobId = clickInfo.event.id;
                        const job = findJob(jobId);
                        if (job) {
                            openJobModal('edit', job);
                        }
                    },
                    
                    eventDrop: (dropInfo) => {
                        const jobId = dropInfo.event.id;
                        const newDate = dropInfo.event.start.toISOString();
                        handleJobDrop(jobId, newDate);
                    },
                    
                    select: (selectionInfo) => {
                        const startDate = selectionInfo.start;
                        const [datePart, timePart] = startDate.toISOString().split('T');
                        const time = timePart ? timePart.substring(0, 5) : '09:00';

                        openJobModal('add');
                        modalDatum.value = datePart;
                        modalTid.value = time;
                    },
                    
                    eventContent: function(arg) {
                        const job = arg.event.extendedProps.originalJob; 
                        
                        if (!job) {
                            return { html: `<div>${arg.event.title}</div>` };
                        }
                        
                        if (job.status === 'avbokad') {
                            return { html: '' }; 
                        }

                        if (arg.view.type === 'listWeek') {
                            const prioIcon = job.prio ? `<span class="fc-event-prio-flag">🚩</span>` : '';
                            const timePart = job.datum ? formatDate(job.datum).split('kl. ')[1] || '' : '';
                            return { 
                                html: `
                                <div class="mobile-calendar-card ${job.prio ? 'prio-row' : ''}">
                                    <span class="card-time-badge">${timePart}</span>
                                    <div class="card-job-details">
                                        <span class="card-job-customer">${prioIcon}${job.kundnamn}</span>
                                        <span class="card-job-regnr">${job.regnr || 'Okänt reg.nr'}</span>
                                    </div>
                                    <span class="status-badge status-${job.status}">${STATUS_TEXT[job.status]}</span>
                                </div>
                                `
                            };
                        }

                        const isMobile = window.innerWidth <= 768;

                        if (isMobile) {
                            const prioClass = job.prio ? 'prio-dot' : '';
                            let contentHtml = `
                                <span class="calendar-job-dot ${prioClass}" title="${job.kundnamn} (${job.regnr || '---'})"></span>
                            `;
                            return { html: contentHtml };

                        } else {
                            const prioIcon = job.prio ? `<span class="fc-event-prio-flag">🚩</span>` : '';
                            let contentHtml = '';
                            
                            if (job.regnr && job.regnr.toUpperCase() !== 'OKÄNT') {
                                contentHtml = `
                                    <div class="reg-plate-small">
                                        <span class="reg-country-small">S</span>
                                        <span class="reg-number-small">${job.regnr}</span>
                                    </div>
                                `;
                            } else {
                                contentHtml = `
                                    <div class="user-plate-small">
                                        <span class="user-icon-small">
                                            <svg class="icon" viewBox="0 0 24 24"><use href="#icon-user"></use></svg>
                                        </span>
                                        <span class="user-name-small">${prioIcon}${job.kundnamn}</span>
                                    </div>
                                `;
                            }
                            
                            return { html: contentHtml };
                        }
                    },
                });
                calendar.render();
            }

            function filterCalendarView() {
                if (!calendar) return;

                const now = new Date();
                now.setHours(0, 0, 0, 0);

                calendar.getEvents().forEach(event => {
                    const job = event.extendedProps.originalJob;
                    if (!job) return;

                    let isVisible = false;
                    switch(currentStatusFilter) {
                        case 'kommande':
                            isVisible = job.status === 'bokad' && new Date(job.datum) >= now;
                            break;
                        case 'klar':
                            isVisible = job.status === 'klar';
                            break;
                        case 'offererad':
                            isVisible = job.status === 'offererad';
                            break;
                        case 'alla':
                            isVisible = true;
                            break;
                    }
                    
                    const classNames = event.classNames.filter(c => c !== 'event-dimmed');
                    if (!isVisible) {
                        classNames.push('event-dimmed');
                    }
                    event.setProp('classNames', classNames);
                });
            }

            // FIXAD: Logik för Dagens Vinst
            function updateDailyProfitInCalendar(jobs) {
                if (currentView !== 'calendar' || !calendar) return;

                const dailyProfits = {};
                
                // Hämta den månad som kalendern visar
                const calendarDate = calendar.getDate();
                const currentMonth = calendarDate.getMonth();
                const currentYear = calendarDate.getFullYear();

                // 1. Summera vinst per dag för "Klar"-jobb
                jobs.filter(j => j.status === 'klar' && j.vinst > 0).forEach(job => {
                    const dateKey = job.datum.split('T')[0];
                    if (!dailyProfits[dateKey]) {
                        dailyProfits[dateKey] = 0;
                    }
                    dailyProfits[dateKey] += job.vinst;
                });

                const profitElements = calendarContainer.querySelectorAll('.calendar-day-profit');
                
                profitElements.forEach(el => {
                    const date = el.dataset.date;
                    const elDate = new Date(date + 'T12:00:00'); // Sätt tid för att undvika tidszonsfel

                    // FIX: Visa bara vinst för dagar i denna månad
                    if (dailyProfits[date] && elDate.getMonth() === currentMonth && elDate.getFullYear() === currentYear) {
                        el.textContent = `+${formatCurrency(dailyProfits[date])}`;
                        el.style.display = ''; 
                    } else {
                        el.textContent = '';
                        el.style.display = 'none'; 
                    }
                });
            }


            function mapJobToEvent(job) {
                return {
                    id: job.id,
                    title: `${job.kundnamn} (${job.regnr || '---'})`,
                    start: job.datum,
                    className: `status-${job.status}`, 
                    extendedProps: {
                        status: job.status,
                        prio: job.prio,
                        originalJob: job 
                    }
                };
            }
            
            async function handleJobDrop(jobId, newDateTime) {
                try {
                    await db.collection("jobs").doc(jobId).update({
                        datum: newDateTime
                    });
                    showToast('Jobb ombokat!');
                } catch (err) {
                    showToast(`Kunde inte flytta jobbet: ${err.message}`, 'danger');
                    console.error(err);
                }
            }
            
            function toggleView(view) {
                currentView = view;
                
                btnToggleTimeline.classList.toggle('active', view === 'timeline');
                btnToggleCalendar.classList.toggle('active', view === 'calendar');
                
                document.querySelector('.mobile-nav-btn[data-view="timeline"]').classList.toggle('active', view === 'timeline');
                document.querySelector('.mobile-nav-btn[data-view="calendar"]').classList.toggle('active', view === 'calendar');

                if (view === 'calendar') {
                    timelineView.style.display = 'none';
                    calendarView.style.display = 'block';
                    appBrandTitle.style.display = 'none'; 

                    calendar.changeView('dayGridTwoWeek'); 
                    
                    const isMobile = window.innerWidth <= 768;
                    if (isMobile) {
                        calendar.setOption('headerToolbar', {
                            left: 'prev,next', center: 'title', right: 'today'
                        });
                    } else {
                        calendar.setOption('headerToolbar', {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridTwoWeek,timeGridWeek,timeGridDay'
                        });
                    }

                    setTimeout(() => {
                        calendar.updateSize();
                        const calendarEvents = allJobs.map(mapJobToEvent);
                        calendar.setOption('events', calendarEvents);
                        
                        filterCalendarView();
                        updateDailyProfitInCalendar(allJobs);

                    }, 50);

                } else {
                    calendarView.style.display = 'none';
                    timelineView.style.display = 'block';
                    appBrandTitle.style.display = 'block'; 
                }
            }


            // --- Firebase Listener ---
            function initRealtimeListener() {
                if (!db) return;

                if (allJobs.length === 0) {
                    showSkeletonLoader();
                }
                
                db.collection("jobs").onSnapshot(snapshot => {
                    allJobs = [];
                    snapshot.forEach(doc => {
                        allJobs.push({ id: doc.id, ...doc.data() });
                    });
                    
                    updateUI();
                    
                }, error => {
                    console.error("Fel vid hämtning av jobb: ", error);
                    alert("Kunde inte ansluta till databasen.");
                });
            }

            function showSkeletonLoader() {
                let skeletonHTML = '';
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    for (let i = 0; i < 5; i++) {
                        skeletonHTML += `
                        <div class="skeleton-card">
                            <div class="skeleton-pulse line-1"></div>
                            <div class="skeleton-pulse line-2"></div>
                            <div class="skeleton-pulse line-3"></div>
                        </div>
                        `;
                    }
                    jobListContainer.innerHTML = `<div id="mobileJobList">${skeletonHTML}</div>`;
                } else {
                    // Desktop skelett-laddare (Bonus)
                    for (let i = 0; i < 5; i++) {
                        skeletonHTML += `
                        <div class="skeleton-table-row">
                            <div class="skeleton-pulse sk-item sk-item-1"></div>
                            <div class="skeleton-pulse sk-item sk-item-2"></div>
                            <div class="skeleton-pulse sk-item sk-item-3"></div>
                            <div class="skeleton-pulse sk-item sk-item-4"></div>
                            <div class="skeleton-pulse sk-item sk-item-5"></div>
                            <div class="skeleton-pulse sk-item sk-item-6"></div>
                        </div>
                        `;
                    }
                    jobListContainer.innerHTML = `<div class="table-container">${skeletonHTML}</div>`;
                }
                jobListContainer.style.display = 'block';
                emptyStateTimeline.style.display = 'none';
            }


            // --- Huvud-renderingsfunktioner ---
            function updateUI() {
                if (!appInitialized) return;

                renderGlobalStats(allJobs);
                const calendarEvents = allJobs.map(mapJobToEvent);
                if (calendar) { // Säkerställ att kalendern är initierad
                    calendar.setOption('events', calendarEvents);
                    filterCalendarView();
                    updateDailyProfitInCalendar(allJobs);
                }
                renderTimeline(); 
                
                // Flyttad från `toggleView` för att säkerställa att vyn alltid är rätt
                if (currentView === 'calendar') {
                    timelineView.style.display = 'none';
                    calendarView.style.display = 'block';
                } else {
                    calendarView.style.display = 'none';
                    timelineView.style.display = 'block';
                }
            }

            function renderGlobalStats(jobs) {
                const now = new Date();
                now.setHours(0, 0, 0, 0);

                const upcomingJobs = jobs.filter(j => j.status === 'bokad' && new Date(j.datum) >= now).length;
                const finishedJobs = jobs.filter(j => j.status === 'klar').length;
                const offeredJobs = jobs.filter(j => j.status === 'offererad').length;
                const allJobCount = jobs.length;
                
                statUpcoming.textContent = upcomingJobs;
                statFinished.textContent = finishedJobs;
                statOffered.textContent = offeredJobs;
                statAll.textContent = allJobCount;
                
                // NYTT: Dagens Vinst i Header
                const todaysProfit = jobs
                    .filter(j => j.status === 'klar' && j.datum && j.datum.startsWith(todayString))
                    .reduce((sum, j) => sum + (j.vinst || 0), 0);
                
                if (todaysProfit > 0) {
                    headerProfitValue.textContent = formatCurrency(todaysProfit);
                    headerProfitDisplay.style.display = 'flex';
                } else {
                    headerProfitDisplay.style.display = 'none';
                }

                document.querySelectorAll('.stat-card.active').forEach(c => c.classList.remove('active'));
                const activeCard = document.getElementById(`stat-card-${currentStatusFilter}`);
                if (activeCard) activeCard.classList.add('active');
            }

            // --- UPPDATERAD: renderTimeline med Animationslogik ---
            function renderTimeline() {
                let jobsToDisplay = [...allJobs];
                
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                
                let sortOrder = 'asc'; 
                
                switch(currentStatusFilter) {
                    case 'kommande':
                        jobsToDisplay = jobsToDisplay.filter(j => 
                            j.status === 'bokad' && new Date(j.datum) >= now
                        );
                        break;
                    case 'klar':
                        jobsToDisplay = jobsToDisplay.filter(j => j.status === 'klar');
                        sortOrder = 'desc'; 
                        break;
                    case 'offererad':
                        jobsToDisplay = jobsToDisplay.filter(j => j.status === 'offererad');
                        break;
                    case 'alla':
                        sortOrder = 'desc'; 
                        break;
                }
                
                if (currentSearchTerm) {
                    jobsToDisplay = jobsToDisplay.filter(job => {
                        const term = currentSearchTerm.toLowerCase();
                        return (
                            job.kundnamn.toLowerCase().includes(term) ||
                            (job.regnr && job.regnr.toLowerCase().includes(term)) ||
                            (job.kommentarer && job.kommentarer.toLowerCase().includes(term)) ||
                            (job.telefon && job.telefon.includes(term)) || // Sök på telefon
                            (STATUS_TEXT[job.status] || '').toLowerCase().includes(term)
                        );
                    });
                }
                
                jobsToDisplay.sort((a, b) => {
                    const dateA = new Date(a.datum);
                    const dateB = new Date(b.datum);
                    if (sortOrder === 'desc') {
                        return dateB - dateA; 
                    } else {
                        return dateA - dateB; 
                    }
                });

                const isMobile = window.innerWidth <= 768;
                let jobElements = jobListContainer.querySelectorAll('.job-entry');
                
                // 1. Tona ut befintliga element
                if (jobElements.length > 0) {
                    jobElements.forEach(el => el.classList.add('fade-out'));
                } else {
                    // Om det inte finns några element, hoppa över väntetiden
                    renderNewContent();
                    return;
                }

                // 2. Vänta på att animationen är klar, rendera sedan nytt innehåll
                setTimeout(renderNewContent, 250); // 250ms matchar CSS-animationen

                function renderNewContent() {
                    let timelineCount = 0;
                    
                    if (isMobile) {
                        timelineCount = renderMobileCardList(jobsToDisplay);
                    } else {
                        timelineCount = renderTimelineTable(jobsToDisplay);
                    }
                    
                    if (timelineCount === 0) {
                        jobListContainer.style.display = 'none';
                        emptyStateTimeline.style.display = 'block';
                        
                        if (currentSearchTerm) {
                            emptyStateTitleTimeline.textContent = "Inga träffar";
                            emptyStateTextTimeline.textContent = `Din sökning på "${currentSearchTerm}" gav inga resultat.`;
                        } else if (allJobs.length > 0) {
                            const filterText = document.querySelector(`.stat-card[data-filter="${currentStatusFilter}"] h3`).textContent;
                            emptyStateTitleTimeline.textContent = `Inga ${filterText.toLowerCase()}`;
                            emptyStateTextTimeline.textContent = "Det finns inga jobb som matchar detta filter.";
                        } else {
                            emptyStateTitleTimeline.textContent = "Du har inga jobb";
                            emptyStateTextTimeline.textContent = "Klicka på '+' för att börja.";
                        }
                    } else {
                        jobListContainer.style.display = 'block';
                        emptyStateTimeline.style.display = 'none';
                    }
                }
            }

            function renderTimelineTable(jobs) {
                jobListContainer.innerHTML = '';
                if (jobs.length === 0) { return 0; }

                let tableHTML = `
                    <div class="table-wrapper">
                        <table id="jobbOversikt">
                            ${createTableHead()}
                            <tbody>
                                ${jobs.map(job => createJobRow(job)).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                jobListContainer.innerHTML = tableHTML;
                return jobs.length;
            }

            function createTableHead() {
                return `
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Datum</th>
                            <th>Kund</th>
                            <th>Reg.nr</th>
                            <th>Kundpris</th>
                            <th class="action-col">Åtgärder</th>
                        </tr>
                    </thead>
                `;
            }

            // --- UPPDATERAD: createJobRow med Kontextuell Ikon ---
            function createJobRow(job) {
                let prioClass = job.prio ? 'prio-row' : '';
                const doneClass = (job.status === 'klar') ? 'done-row' : '';
                
                const isKommandePrio = job.prio && job.status === 'bokad' && new Date(job.datum) >= new Date();
                if(isKommandePrio) {
                    prioClass += ' kommande-prio-pulse';
                }

                const prioIcon = job.prio ? `<svg class="icon-sm prio-flag-icon" viewBox="0 0 24 24"><use href="#icon-flag"></use></svg>` : '';
                const hasComment = job.kommentarer && job.kommentarer.trim().length > 0;
                const kundnamnHTML = highlightSearchTerm(job.kundnamn, currentSearchTerm);
                const regnrHTML = highlightSearchTerm(job.regnr || '---', currentSearchTerm);
                const contextIcon = getJobContextIcon(job); // <-- NYTT
                
                return `
                    <tr data-id="${job.id}" data-status="${job.status}" class="job-entry ${prioClass} ${doneClass}">
                        <td data-label="Status"><span class="status-badge status-${job.status || 'bokad'}">${STATUS_TEXT[job.status] || 'Bokad'}</span></td>
                        <td data-label="Datum">${formatDate(job.datum)}</td>
                        <td data-label="Kund">
                            ${prioIcon}
                            ${contextIcon} <button class="link-btn customer-link" data-kund="${job.kundnamn}">
                                ${kundnamnHTML}
                            </button>
                        </td>
                        <td data-label="Reg.nr">
                            ${(job.regnr && job.regnr.toUpperCase() !== 'OKÄNT') ? `
	                        <button class="car-link reg-plate" data-regnr="${job.regnr}">
	                            <span class="reg-country">S</span>
	                            <span class="reg-number">${regnrHTML}</span>
	                        </button>
                            ` : '---'}
                    	</td>
                        <td data-label="Kundpris">${formatCurrency(job.kundpris)}</td>
                        <td class="action-col">
                            ${hasComment ? `
                            <button class="icon-btn" data-action="showComment" data-comment="${encodeURIComponent(job.kommentarer)}" title="Visa kommentar" aria-label="Visa kommentar">
                                <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-chat"></use></svg>
                            </button>
                            ` : `<span class="icon-btn-placeholder"></span>`}
                            
                            <button class="icon-btn" data-action="togglePrio" title="Växla Prio" aria-label="Växla Prio">
                                <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-flag"></use></svg>
                            </button>
                            <button class="icon-btn" data-action="setStatusKlar" title="Markera som Klar" aria-label="Markera som Klar">
                                <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-check"></use></svg>
                            </button>
                            
                            <button class="icon-btn delete-btn" data-id="${job.id}" title="Ta bort" aria-label="Ta bort jobb">
                                <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-trash"></use></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            function renderMobileCardList(jobs) {
                jobListContainer.innerHTML = '';
                if (jobs.length === 0) { return 0; }
                
                const groupedJobs = jobs.reduce((acc, job) => {
                    const dateKey = job.datum ? job.datum.split('T')[0] : 'Okänt';
                    if (!acc[dateKey]) {
                        acc[dateKey] = [];
                    }
                    acc[dateKey].push(job);
                    return acc;
                }, {});
                
                let listHTML = '<div id="mobileJobList">';
                
                const sortOrder = (currentStatusFilter === 'klar' || currentStatusFilter === 'alla') ? 'desc' : 'asc';
                const sortedDateKeys = Object.keys(groupedJobs).sort((a, b) => {
                     if (sortOrder === 'desc') {
                        return new Date(b) - new Date(a);
                    } else {
                        return new Date(a) - new Date(b);
                    }
                });
                
                for (const dateKey of sortedDateKeys) {
                    const jobsForDay = groupedJobs[dateKey];
                    const firstJobDate = jobsForDay[0].datum;
                    
                    listHTML += `<div class="mobile-day-group">`;
                    listHTML += `<h2 class="mobile-date-header">${formatDate(firstJobDate, { onlyDate: true })}</h2>`;
                    listHTML += jobsForDay.map(job => createJobCard(job)).join('');
                    listHTML += `</div>`;
                }
                
                listHTML += '</div>';
                jobListContainer.innerHTML = listHTML;
                return jobs.length;
            }
            
            // --- UPPDATERAD: createJobCard med Kontextuell Ikon ---
            function createJobCard(job) {
                let prioClass = job.prio ? 'prio-row' : '';
                const doneClass = (job.status === 'klar') ? 'done-row' : '';
                
                const isKommandePrio = job.prio && job.status === 'bokad' && new Date(job.datum) >= new Date();
                if(isKommandePrio) {
                    prioClass += ' kommande-prio-pulse';
                }

                const hasComment = job.kommentarer && job.kommentarer.trim().length > 0;
                
                const kundnamnHTML = highlightSearchTerm(job.kundnamn, currentSearchTerm);
                const regnrHTML = highlightSearchTerm(job.regnr || 'OKÄNT', currentSearchTerm);
                const contextIcon = getJobContextIcon(job); // <-- NYTT
                
                const timePart = job.datum ? (formatDate(job.datum).split('kl. ')[1] || 'Okänd tid') : 'Okänd tid';
                
                return `
                    <div class="mobile-job-card job-entry ${prioClass} ${doneClass}" data-id="${job.id}" data-status="${job.status}">
                        <div class="card-content">
                            <div class="card-row">
                                <span class="card-label">Kund</span>
                                <span class="card-value customer-name">
                                    <div class="customer-name-wrapper">
                                        ${contextIcon}
                                        <button class="link-btn customer-link" data-kund="${job.kundnamn}">${kundnamnHTML}</button>
                                    </div>
                                </span>
                            </div>
                            <div class="card-row">
                                <span class="card-label">Reg.nr</span>
                                <span class="card-value">
                                    ${(job.regnr && job.regnr.toUpperCase() !== 'OKÄNT') ? `
                                    <button class="car-link reg-plate" data-regnr="${job.regnr}">
                                        <span class="reg-country">S</span>
                                        <span class="reg-number">${regnrHTML}</span>
                                    </button>
                                    ` : `
                                    <span class="reg-unknown">${regnrHTML}</span>
                                    `}
                                </span>
                            </div>
                            <div class="card-row">
                                <span class="card-label">Tid / Status</span>
                                <span class="card-value time-status-wrapper">
                                    <span class="card-time-badge">${timePart}</span>
                                    <span class="status-badge status-${job.status || 'bokad'}">${STATUS_TEXT[job.status] || 'Bokad'}</span>
                                </span>
                            </div>
                            <div class="card-row">
                                <span class="card-label">Kundpris</span>
                                <span class="card-value customer-price">${formatCurrency(job.kundpris)}</span>
                            </div>
                        </div>
                        <div class="action-col">
                            ${hasComment ? `
                            <button class="icon-btn" data-action="showComment" data-comment="${encodeURIComponent(job.kommentarer)}" aria-label="Visa kommentar">
                                <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-chat"></use></svg>
                            </button>
                            ` : `<span class="icon-btn-placeholder"></span>`}
                            
                            <button class="icon-btn" data-action="togglePrio" aria-label="Växla Prio">
                                <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-flag"></use></svg>
                            </button>
                            <button class="icon-btn" data-action="setStatusKlar" aria-label="Markera som Klar">
                                <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-check"></use></svg>
                            </button>
                            
                            <button class="icon-btn delete-btn" data-id="${job.id}" aria-label="Ta bort jobb">
                                <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-trash"></use></svg>
                            </button>
                        </div>
                    </div>
                `;
            }

            // --- Popover, Modal-hantering (FIXAD HISTORIK) ---
            
            function closeModal(options = {}) {
                const { popHistory = true } = options; 

                if (!isModalOpen) return;
                
                const modalId = currentOpenModalId;
                const modalElement = document.getElementById(modalId);
                
                if (modalElement) {
                    modalElement.classList.remove('show');
                    if (modalElement.id === 'jobModal') {
                        kundnamnSuggestions.style.display = 'none';
                        kundnamnSuggestions.innerHTML = '';
                    }
                    setTimeout(() => {
                        modalElement.style.display = 'none';
                    }, 200);
                }

                if (popHistory && !isNavigatingBack && history.state && history.state.modal === modalId) {
                    history.back();
                }
                
                isModalOpen = false;
                currentOpenModalId = null;
            }

			searchBar.addEventListener('input', () => {
			    if (desktopSearchWrapper) {
			        desktopSearchWrapper.classList.add('is-searching');
			    }
			});

            window.addEventListener('popstate', (event) => {
                if (isModalOpen) {
                    isNavigatingBack = true;
                    closeModal({ popHistory: false }); // Stäng modalen utan att ändra historiken
                    isNavigatingBack = false;
                }
            });

            function showModal(modalId) {
                if (isModalOpen) {
                    closeModal({ popHistory: false }); 
                }
                
                const modalElement = document.getElementById(modalId);
                if (!modalElement) {
                    console.error(`Modal med id "${modalId}" hittades inte.`);
                    return;
                }

                modalElement.style.display = 'flex';
                setTimeout(() => modalElement.classList.add('show'), 10);
                
                isModalOpen = true;
                currentOpenModalId = modalId;
                
                // PUNKT 7: Undvik att pusha historik för mobil sök-modal
                if (history.state?.modal !== modalId && modalId !== 'mobileSearchModal') {
                    try {
                        history.pushState({ modal: modalId }, `Modal ${modalId}`, `#${modalId}`);
                    } catch (e) {
                        console.warn("Kunde inte använda history.pushState", e);
                    }
                }

                // Tabb-fälla (Bonus)
                const focusableElements = modalElement.querySelectorAll(
                    'a[href], button, input, textarea, select, [tabindex]:not([tabindex="-1"])'
                );
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];

                if (firstElement) {
                    setTimeout(() => firstElement.focus(), 50); 
                }

                modalElement.addEventListener('keydown', (e) => {
                    if (e.key !== 'Tab') return;

                    if (e.shiftKey) { 
                        if (document.activeElement === firstElement) {
                            lastElement.focus();
                            e.preventDefault();
                        }
                    } else { 
                        if (document.activeElement === lastElement) {
                            firstElement.focus();
                            e.preventDefault();
                        }
                    }
                });
            }


            function showCommentPopover(button) {
                const commentText = decodeURIComponent(button.dataset.comment);
                commentPopoverContent.textContent = commentText;
                const rect = button.getBoundingClientRect();
                
                commentPopover.style.display = 'block'; // Visa först för att mäta
                
                const popoverWidth = commentPopover.offsetWidth;
                const popoverHeight = commentPopover.offsetHeight;

                commentPopover.classList.remove('arrow-top', 'arrow-bottom');

                let popoverTop = rect.bottom + window.scrollY + 8; // 8px marginal
                let popoverLeft = rect.left + window.scrollX - (popoverWidth / 2) + (rect.width / 2);

                // Justera vänster/höger
                if (popoverLeft < 10) {
                    popoverLeft = 10;
                } else if (popoverLeft + popoverWidth > window.innerWidth - 10) {
                    popoverLeft = window.innerWidth - popoverWidth - 10;
                }
                
                // Justera topp/botten
                if (popoverTop + popoverHeight > window.innerHeight + window.scrollY - 10) {
                    // Visa ovanför
                    popoverTop = rect.top + window.scrollY - popoverHeight - 8; // 8px marginal
                    commentPopover.classList.add('arrow-bottom'); 
                } else {
                    // Visa nedanför
                    commentPopover.classList.add('arrow-top'); 
                }
                
                // PUNKT 5 (FIX): `popoverTop` var felaktigt, ska vara `popoverLeft`
                // Sätt pilens position
                const arrowOffset = rect.left + (rect.width / 2) - popoverLeft;
                commentPopover.style.setProperty('--arrow-left-offset', `${arrowOffset}px`);

                commentPopover.style.top = `${popoverTop}px`;
                commentPopover.style.left = `${popoverLeft}px`;
                
                popoverBackdrop.classList.add('show');
                commentPopover.classList.add('show');
            }
			
            function hideCommentPopover() {
                popoverBackdrop.classList.remove('show');
                commentPopover.classList.remove('show');
				commentPopover.classList.remove('arrow-top', 'arrow-bottom');
            }
            function updateLiveProfit() {
                const pris = parseFloat(modalKundpris.value) || 0;
                const utgift = parseFloat(modalUtgifter.value) || 0;
                const vinst = pris - utgift;
                modalVinstKalkyl.textContent = `Vinst: ${formatCurrency(vinst)}`;
                modalVinstKalkyl.style.color = vinst < 0 ? 'var(--danger-color)' : (vinst > 0 ? 'var(--success-color)' : 'var(--text-color)');
            }
            
            // NYTT: Funktion för att synka quick-buttons med select
            function syncStatusUI(newStatus) {
                modalStatusSelect.value = newStatus;
                quickStatusButtons.querySelectorAll('.button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.status === newStatus);
                });
            }

            quickStatusButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.button[data-status]');
                if (button) {
                    syncStatusUI(button.dataset.status);
                }
            });

            function openJobModal(mode, dataToClone = null) {
                jobModalForm.reset();
                if (mode === 'add') {
                    modalTitle.textContent = 'Lägg till nytt jobb';
                    modalSaveBtn.textContent = 'Spara'; 
                    modalJobId.value = '';
                    if (dataToClone) {
                        syncStatusUI(dataToClone.status || 'bokad');
                        document.getElementById('prio').checked = dataToClone.prio || false;
                        modalDatum.value = dataToClone.datum || todayString;
                        modalTid.value = dataToClone.tid || new Date().toTimeString().substring(0,5);
                        modalRegnr.value = dataToClone.regnr;
                        modalKundnamn.value = dataToClone.kundnamn.toUpperCase();
                        modalTelefon.value = dataToClone.telefon || '';
                        modalKundpris.value = dataToClone.kundpris;
                        modalUtgifter.value = dataToClone.utgifter;
                        document.getElementById('kommentarer').value = dataToClone.kommentarer;
						document.getElementById('matarstallning').value = dataToClone.matarstallning || '';
                    } else {
                        syncStatusUI('bokad');
                        document.getElementById('prio').checked = false;
                        const now = new Date();
                        modalDatum.value = todayString;
                        modalTid.value = now.toTimeString().substring(0,5);
                    }
                } 
                else if (mode === 'edit' && dataToClone) {
                    modalTitle.textContent = 'Redigera Jobb';
                    modalSaveBtn.textContent = 'Spara'; 
                    modalJobId.value = dataToClone.id;
                    syncStatusUI(dataToClone.status || 'bokad');
                    document.getElementById('prio').checked = dataToClone.prio || false;
                    if (dataToClone.datum) {
                        const d = new Date(dataToClone.datum);
                        modalDatum.value = d.toISOString().split('T')[0];
                        modalTid.value = d.toTimeString().substring(0,5);
                    } else {
                        modalDatum.value = ''; modalTid.value = '';
                    }
                    modalRegnr.value = dataToClone.regnr;
                    modalKundnamn.value = dataToClone.kundnamn.toUpperCase();
                    modalTelefon.value = dataToClone.telefon || '';
                    modalKundpris.value = dataToClone.kundpris;
                    modalUtgifter.value = dataToClone.utgifter;
                    document.getElementById('kommentarer').value = dataToClone.kommentarer;
					document.getElementById('matarstallning').value = dataToClone.matarstallning || '';
                }
                updateLiveProfit();
                showModal('jobModal'); 
                modalKundnamn.focus();
            }
            
            function getJobDataFromForm() {
                const kundpris = parseFloat(modalKundpris.value) || 0;
                const utgifter = parseFloat(modalUtgifter.value) || 0;
                return {
                    id: modalJobId.value,
                    status: modalStatusSelect.value, // Läs från <select>
                    datum: modalDatum.value,
                    tid: modalTid.value,
                    regnr: modalRegnr.value.toUpperCase(),
                    kundnamn: document.getElementById('kundnamn').value.toUpperCase(),
                    telefon: modalTelefon.value, // NYTT FÄLT
                    kundpris: kundpris,
                    utgifter: utgifter,
                    vinst: kundpris - utgifter,
                    kommentarer: document.getElementById('kommentarer').value,
                    prio: document.getElementById('prio').checked,
					matarstallning: document.getElementById('matarstallning').value
                };
            }
            
            // BONUS: Om-renderar jobblistan i kund/bil-modal
            function renderDetailJobList(listElement, jobs, filterTerm) {
                const filteredJobs = jobs.filter(job => {
                    const term = filterTerm.toLowerCase();
                    return !term ||
                           formatDate(job.datum).toLowerCase().includes(term) ||
                           (job.regnr && job.regnr.toLowerCase().includes(term)) ||
                           job.kundnamn.toLowerCase().includes(term) ||
                           (job.kommentarer && job.kommentarer.toLowerCase().includes(term));
                });

                listElement.innerHTML = filteredJobs.map(job => {
                    const prioIcon = job.prio ? `<svg class="icon-sm prio-flag-icon" viewBox="0 0 24 24"><use href="#icon-flag"></use></svg>` : '';
                    return `<li data-job-id="${job.id}">
                                <div>
                                    <span class="job-date">${prioIcon}${formatDate(job.datum)}</span>
                                    <span class="job-subline">${job.regnr || job.kundnamn} (${STATUS_TEXT[job.status]})</span>
                                    ${job.kommentarer ? `<p class="job-comment">${job.kommentarer}</p>` : ''}
                                </div>
                                <span class="job-profit profit ${job.vinst > 0 ? 'positive' : ''}">${formatCurrency(job.vinst)}</span>
                            </li>`
                }).join('');
            }

            function openCustomerModal(kundnamn) {
                const customerJobs = allJobs.filter(j => j.kundnamn === kundnamn).sort((a, b) => new Date(b.datum) - new Date(a.datum));
                if (customerJobs.length === 0) return;
                
                const latestPhone = customerJobs.find(j => j.telefon)?.telefon || 'Inget tel.nr sparat';
                const totalVinst = customerJobs.reduce((sum, j) => sum + (j.vinst || 0), 0);
                
                customerModalName.textContent = kundnamn;
                customerModalPhone.textContent = latestPhone;
                customerModalTotalProfit.textContent = formatCurrency(totalVinst);
                customerModalTotalProfit.className = totalVinst > 0 ? 'stat-value positive' : 'stat-value';
                customerModalJobCount.textContent = customerJobs.length;
                
                customerSearch.value = ''; 
                renderDetailJobList(customerModalJobList, customerJobs, ''); 
                showModal('customerModal'); 
            }
            
            // NY (PUNKT 6): Hanterare för redigeringsknappen
            editCustomerPhoneBtn.addEventListener('click', () => {
                const kundnamn = customerModalName.textContent;
                const customerJobs = allJobs
                    .filter(j => j.kundnamn === kundnamn)
                    .sort((a, b) => new Date(b.datum) - new Date(a.datum));
                
                if (customerJobs.length > 0) {
                    const latestJob = customerJobs[0]; // Ta det senaste jobbet
                    
                    if (history.state?.modal) {
                        isNavigatingBack = true;
                        history.back();
                        isNavigatingBack = false;
                    } else {
                        closeModal({ popHistory: false });
                    }
                    
                    setTimeout(() => {
                        openJobModal('edit', latestJob);
                        // Fokusera på telefonfältet
                        setTimeout(() => modalTelefon.focus(), 100); 
                    }, 50);
                }
            });


            function openCarModal(regnr) {
                if (!regnr) return;
                const carJobs = allJobs.filter(j => j.regnr === regnr).sort((a, b) => new Date(b.datum) - new Date(a.datum));
                if (carJobs.length === 0) return;

                const latestOwner = carJobs[0].kundnamn;
                const totalVinst = carJobs.reduce((sum, j) => sum + (j.vinst || 0), 0);
                
                const biluppgifterUrl = `https://biluppgifter.se/fordon/${regnr}#vehicle-data`;
                
                carModalRegnr.textContent = regnr;
                carModalExternalLink.href = biluppgifterUrl;
                carModalExternalLinkMobile.href = biluppgifterUrl; 
                carModalOwner.textContent = `Senaste ägare: ${latestOwner}`;
                carModalTotalProfit.textContent = formatCurrency(totalVinst);
                carModalTotalProfit.className = totalVinst > 0 ? 'stat-value positive' : 'stat-value';
                carModalJobCount.textContent = carJobs.length;

                carSearch.value = ''; 
                renderDetailJobList(carModalJobList, carJobs, ''); 
                showModal('carModal'); 
            }

			function openStatsModal() {
                const completedJobs = allJobs.filter(j => j.status === 'klar');
                const totalVinst = completedJobs.reduce((sum, j) => sum + (j.vinst || 0), 0);
                const totalJobb = completedJobs.length;

                statsModalTotalProfit.textContent = formatCurrency(totalVinst);
                statsModalJobCount.textContent = totalJobb;
                statsModalTotalProfit.className = totalVinst > 0 ? 'stat-value positive' : 'stat-value';

                const now = new Date();
                const currentMonthKey = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
                
                const goal = parseFloat(currentProfitGoal) || 0;
                
                const thisMonthVinst = completedJobs
                    .filter(job => job.datum.startsWith(currentMonthKey))
                    .reduce((sum, j) => sum + (j.vinst || 0), 0);

                if (goal > 0) {
                    profitGoalProgress.style.display = 'block';
                    profitGoalCurrent.textContent = formatCurrency(thisMonthVinst);
                    profitGoalTarget.textContent = `Mål: ${formatCurrency(goal)}`;
                    const percent = Math.min((thisMonthVinst / goal) * 100, 100);
                    profitGoalFill.style.width = `${percent}%`;
                } else {
                    profitGoalProgress.style.display = 'none'; 
                }

                const monthlyStats = completedJobs.reduce((acc, job) => {
                    try {
                        const d = new Date(job.datum);
                        const key = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
                        
                        if (!acc[key]) {
                            acc[key] = {
                                key: key,
                                year: d.getFullYear(),
                                month: d.getMonth() + 1,
                                monthName: new Date(d.getFullYear(), d.getMonth()).toLocaleString(locale, { month: 'short' }),
                                vinst: 0,
                                jobb: 0
                            };
                        }
                        
                        acc[key].vinst += (job.vinst || 0);
                        acc[key].jobb += 1;

                    } catch(e) { /* Ignorera ogiltiga datum */ }
                    return acc;
                }, {});

                const statsArray = Object.values(monthlyStats);
                statsArray.sort((a, b) => b.key.localeCompare(a.key));
                
                let tableHtml = `
                    <table id="statsModalTable">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Antal Jobb</th>
                                <th style="text-align: right;">Total Vinst</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                if (statsArray.length === 0) {
                    tableHtml += `<tr><td colspan="3" style="text-align: center; padding: 2rem;">Inga klarmarkerade jobb att visa.</td></tr>`;
                } else {
                    statsArray.forEach(item => {
                        const monthName = new Date(item.year, item.month - 1)
                            .toLocaleString(locale, { month: 'long' });
                        
                        tableHtml += `
                            <tr>
                                <td>
                                    <span class="stat-month">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</span>
                                    <span class="stat-year">${item.year}</span>
                                </td>
                                <td style="text-align: center;">${item.jobb}</td>
                                <td class="stat-profit">${formatCurrency(item.vinst)}</td>
                            </tr>
                        `;
                    });
                }
                tableHtml += `</tbody></table>`;
                
                statsModalBody.querySelector('#statsModalTable')?.remove(); 
                statsModalBody.insertAdjacentHTML('beforeend', tableHtml);

                // --- MÅNADSGRAF (BEFINTLIG) ---
                const chartData = Object.values(monthlyStats).sort((a, b) => a.key.localeCompare(b.key));
                const recentChartData = chartData.slice(-12); 

                const chartLabels = recentChartData.map(d => `${d.monthName} ${d.year}`);
                const chartVinstData = recentChartData.map(d => d.vinst);
                
                const ctx = document.getElementById('statsChart').getContext('2d');
                
                if (statsChartInstance) {
                    statsChartInstance.destroy(); 
                }

                statsChartInstance = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Vinst per Månad',
                            data: chartVinstData,
                            backgroundColor: 'rgba(10, 132, 255, 0.7)', 
                            borderColor: 'rgba(10, 132, 255, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return ` Vinst: ${formatCurrency(context.raw)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });

                // --- VECKODAGSGRAF (NY KOD HÄR) ---
                
                // 1. Definiera labels och data-array FÖRST
                const weekdayLabels = ['Mån', 'Tis', 'Ons', 'Tor', 'Fre', 'Lör', 'Sön'];
                const weekdayCounts = [0, 0, 0, 0, 0, 0, 0]; // 7 dagar, Mån=0, Sön=6

                // 2. Fyll på data-arrayen
                completedJobs.forEach(job => {
                    try {
                        const d = new Date(job.datum);
                        let dayOfWeek = d.getDay(); // 0=Söndag, 1=Måndag, ... 6=Lördag

                        if (dayOfWeek === 0) {
                            dayOfWeek = 6; // Flytta Söndag till slutet
                        } else {
                            dayOfWeek = dayOfWeek - 1; // Flytta Mån-Lör ett steg bakåt
                        }
                        
                        if(dayOfWeek >= 0 && dayOfWeek <= 6) {
                            weekdayCounts[dayOfWeek]++;
                        }
                    } catch(e) { /* Ignorera ogiltiga datum */ }
                });

                // 3. Hämta canvas och förstör gammal instans
                const weekdayCtx = document.getElementById('weekdayChart').getContext('2d');
                
                if (weekdayChartInstance) {
                    weekdayChartInstance.destroy(); 
                }

                // 4. Skapa den nya grafen
                weekdayChartInstance = new Chart(weekdayCtx, {
                    type: 'bar',
                    data: {
                        labels: weekdayLabels, // Använd den definierade variabeln
                        datasets: [{
                            label: 'Antal Jobb',
                            data: weekdayCounts, // Använd den definierade variabeln
                            backgroundColor: 'rgba(48, 209, 88, 0.7)',
                            borderColor: 'rgba(48, 209, 88, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return ` Antal Jobb: ${context.raw}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1 
                                }
                            }
                        }
                    }
                });
                
                // Slutligen, visa modalen
                showModal('statsModal');
            }
            
            function showContextMenu(e, jobId) {
                hideContextMenu();
                e.preventDefault();
                
                const job = allJobs.find(j => j.id === jobId);
                if (!job) return;
                
                contextMenuJobId = jobId; 
                
                const prioText = job.prio ? 'Ta bort Prio' : 'Sätt Prio';
                
                contextMenu.innerHTML = `
                    <button class="context-menu-button" data-action="edit">
                        <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-pencil"></use></svg>
                        <span>Redigera...</span>
                    </button>
                    <button class="context-menu-button" data-action="prio">
                        <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-flag"></use></svg>
                        <span>${prioText}</span>
                    </button>
                    <button class="context-menu-button" data-action="duplicate">
                        <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-duplicate"></use></svg>
                        <span>Duplicera</span>
                    </button>
                    <div class="context-menu-divider"></div>
                    <button class="context-menu-button" data-action="setStatusKlar">
                        <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-check"></use></svg>
                        <span>Markera som Klar</span>
                    </button>
                    <button class="context-menu-button" data-action="setStatusBokad">
                        <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-briefcase"></use></svg>
                        <span>Markera som Bokad</span>
                    </button>
                    <div class="context-menu-divider"></div>
                    <button class="context-menu-button danger" data-action="delete">
                        <svg class="icon-sm" viewBox="0 0 24 24"><use href="#icon-trash"></use></svg>
                        <span>Ta bort</span>
                    </button>
                `;
                
                contextMenu.style.left = `${e.clientX}px`;
                contextMenu.style.top = `${e.clientY}px`;
                contextMenu.classList.add('show');
            }
            function hideContextMenu() {
                contextMenu.classList.remove('show');
                contextMenuJobId = null;
            }
            
            // --- Åtgärdsfunktioner ---
            function findJob(jobId) {
                return allJobs.find(j => j.id === jobId);
            }
            function deleteJob(jobId) {
                if (confirm('Är du säker på att du vill ta bort detta jobb från molnet?')) {
                    db.collection("jobs").doc(jobId).delete()
                        .then(() => showToast('Jobb borttaget från molnet.', 'danger'))
                        .catch(err => showToast(`Fel: ${err.message}`, 'danger'));
                }
            }
            function togglePrio(jobId) {
                const job = findJob(jobId);
                if (job) {
                    db.collection("jobs").doc(jobId).update({ prio: !job.prio })
                    .then(() => showToast(job.prio ? 'Prio borttagen.' : 'Jobb markerat som prio!'))
                    .catch(err => showToast(`Fel: ${err.message}`, 'danger'));
                }
            }
            function duplicateJob(jobId) {
                const job = findJob(jobId);
                if (job) {
                    const jobData = {...job};
                    delete jobData.id;
                    jobData.datum = todayString;
                    jobData.tid = new Date().toTimeString().substring(0,5);
                    openJobModal('add', jobData);
                    showToast('Jobb duplicerat. Sätt nytt datum och spara.');
                }
            }
            function quickSetStatus(jobId, newStatus) {
                const job = findJob(jobId);
                if (job && job.status !== newStatus) {
                    db.collection("jobs").doc(jobId).update({
                        status: newStatus
                    })
                    .then(() => {
                        if (newStatus === 'klar') {
                            // Tyst, hanteras av "Ångra"-toasten
                        } else {
                            const statusText = STATUS_TEXT[newStatus] || newStatus;
                            showToast(`Jobb markerat som "${statusText}".`);
                        }
                    })
                    .catch(err => showToast(`Fel: ${err.message}`, 'danger'));
                }
            }
            
            // --- `handleFormSubmit` med Spinner ---
            async function handleFormSubmit(e) {
                e.preventDefault();
                const jobData = getJobDataFromForm();
                
                if (jobData.status === 'klar' && jobData.kundpris === 0) {
                    alert('Ett "Klar" jobb kan inte ha 0 kr i kundpris.');
                    return;
                }
                const fullDatum = `${jobData.datum}T${jobData.tid || '09:00'}`;
                
                const savedData = { 
                    status: jobData.status, datum: fullDatum, regnr: jobData.regnr,
                    kundnamn: jobData.kundnamn,
                    telefon: jobData.telefon, // NYTT FÄLT
                    kundpris: jobData.kundpris, utgifter: jobData.utgifter,
                    vinst: jobData.vinst, kommentarer: jobData.kommentarer, prio: jobData.prio,
					matarstallning: jobData.matarstallning
                };
                
                const originalButtonText = modalSaveBtn.textContent;
                modalSaveBtn.disabled = true;
                modalSaveBtn.innerHTML = `
                    <span>Sparar...</span>
                    <div class="button-spinner"></div>
                `;

                try {
                    if (jobData.id) {
                        await db.collection("jobs").doc(jobData.id).update(savedData);
                        showToast('Jobb uppdaterat i molnet!');
                    } else {
                        await db.collection("jobs").add(savedData);
                        showToast('Jobb sparat i molnet!');
                    }
                    closeModal();
                } catch (err) {
                    showToast(`Fel: ${err.message}`, 'danger');
                } finally {
                    modalSaveBtn.disabled = false;
                    modalSaveBtn.innerHTML = originalButtonText;
                }
            }
            
            // --- `jobListContainer` klick-hanterare med "Ångra" ---
            jobListContainer.addEventListener('click', (e) => {
                const target = e.target;
                
                const actionButton = target.closest('.icon-btn');
                const customerLink = target.closest('.customer-link');
                const carLink = target.closest('.car-link');
                
                const jobElement = target.closest('tr[data-id], .mobile-job-card[data-id]');
                
                if (!jobElement) return;
                const id = jobElement.dataset.id;
                
                if (actionButton) {
                    const action = actionButton.dataset.action;
                    if (action) {
                        e.stopPropagation();
                        switch (action) {
                            case 'showComment':
                                showCommentPopover(actionButton);
                                return;
                            case 'togglePrio':
                                togglePrio(id);
                                return;
                            
                            case 'setStatusKlar': { 
                                const job = findJob(id);
                                if (!job) return;
                                
                                const originalStatus = job.status;
                                if (originalStatus === 'klar') return; 

                                quickSetStatus(id, 'klar');
                                
                                showToast('Jobb markerat som "Klar"', 'success', () => {
                                    quickSetStatus(id, originalStatus);
                                    showToast('Status återställd.', 'info');
                                });
                                return;
                            }
                        }
                    }
                    if (actionButton.classList.contains('delete-btn')) {
                        e.stopPropagation();
                        deleteJob(id);
                        return;
                    }
                }
                
                if (customerLink) { e.stopPropagation(); openCustomerModal(customerLink.dataset.kund); return; }
                if (carLink) { e.stopPropagation(); openCarModal(carLink.dataset.regnr); return; }
                
                const job = findJob(id);
                if (job) openJobModal('edit', job);
            });
            
            // --- Långtryck- & Kontextmeny-hanterare ---
            jobListContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault(); 
                if (window.innerWidth <= 768) {
                    return; 
                }
                const row = e.target.closest('tr[data-id]');
                if (row) showContextMenu(e, row.dataset.id);
            });
            
            let touchTimer;
            let touchStartX, touchStartY;
            
            jobListContainer.addEventListener('touchstart', (e) => {
                const jobElement = e.target.closest('.mobile-job-card[data-id]');
                if (!jobElement) return;

                const jobId = jobElement.dataset.id;
                const touch = e.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;

                touchTimer = setTimeout(() => {
                    e.preventDefault(); 
                    
                    const longPressEvent = {
                        clientX: touchStartX,
                        clientY: touchStartY,
                        preventDefault: () => {}
                    };
                    showContextMenu(longPressEvent, jobId);
                    
                }, 750); 

            }, { passive: true });

            jobListContainer.addEventListener('touchmove', (e) => {
                if (!touchTimer) return;
                const touch = e.touches[0];
                if (Math.abs(touch.clientX - touchStartX) > 10 || Math.abs(touch.clientY - touchStartY) > 10) {
                    clearTimeout(touchTimer);
                    touchTimer = null;
                }
            });

            jobListContainer.addEventListener('touchend', (e) => {
                clearTimeout(touchTimer); 
                touchTimer = null;
            });
            
            jobListContainer.addEventListener('touchcancel', (e) => {
                clearTimeout(touchTimer); 
                touchTimer = null;
            });
            
            contextMenu.addEventListener('click', (e) => {
                const action = e.target.closest('.context-menu-button')?.dataset.action;
                if (!action || !contextMenuJobId) {
                    hideContextMenu();
                    return;
                }
                switch(action) {
                    case 'edit': const job = findJob(contextMenuJobId); if(job) openJobModal('edit', job); break;
                    case 'prio': togglePrio(contextMenuJobId); break;
                    case 'duplicate': duplicateJob(contextMenuJobId); break; 
                    
                    case 'setStatusKlar': {
                        const job = findJob(contextMenuJobId);
                        if (!job) return;
                        const originalStatus = job.status;
                        if (originalStatus === 'klar') return; 
                        quickSetStatus(contextMenuJobId, 'klar');
                        showToast('Jobb markerat som "Klar"', 'success', () => {
                            quickSetStatus(contextMenuJobId, originalStatus);
                            showToast('Status återställd.', 'info');
                        });
                        break;
                    }
                    
                    case 'setStatusBokad': quickSetStatus(contextMenuJobId, 'bokad'); break;
                    case 'delete': deleteJob(contextMenuJobId); break;
                }
                hideContextMenu();
            });
            
            window.addEventListener('click', () => { hideCommentPopover(); hideContextMenu(); });
            popoverBackdrop.addEventListener('click', hideCommentPopover);
            commentPopoverClose.addEventListener('click', hideCommentPopover);

            // --- Sök-hanterare (Med rensa-knappar) ---
            function performSearch() {
			    const desktopQuery = searchBar.value;
			    const mobileQuery = mobileSearchBar.value;
			
			    currentSearchTerm = (desktopQuery.length > mobileQuery.length) ? desktopQuery : mobileQuery;
			
                desktopSearchClear.style.display = desktopQuery.length > 0 ? 'flex' : 'none';
                mobileSearchClear.style.display = mobileQuery.length > 0 ? 'flex' : 'none';

			    clearDayFilterBtn.style.display = currentSearchTerm ? 'inline-flex' : 'none';
			    renderTimeline();
			
			    if (desktopSearchWrapper) {
			        desktopSearchWrapper.classList.remove('is-searching');
			    }
			}

            searchBar.addEventListener('input', debounce(performSearch, 300));
            mobileSearchBar.addEventListener('input', debounce(performSearch, 300));

            mobileSearchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                mobileSearchBar.blur(); 
                closeModal(); 
                performSearch(); 
            });
            
            function clearSearch() {
                searchBar.value = '';
			    mobileSearchBar.value = '';
			    currentSearchTerm = '';
			    
                clearDayFilterBtn.style.display = 'none';
                desktopSearchClear.style.display = 'none';
                mobileSearchClear.style.display = 'none';

			    renderTimeline();
			    
			    if (desktopSearchWrapper) {
			        desktopSearchWrapper.classList.remove('is-searching');
			    }
            }
            
            clearDayFilterBtn.addEventListener('click', () => {
                clearSearch();
                searchBar.focus();
            });
            
            desktopSearchClear.addEventListener('click', () => {
                clearSearch();
                searchBar.focus();
            });

            mobileSearchClear.addEventListener('click', () => {
                clearSearch();
                mobileSearchBar.focus();
            });
            
            // --- Filter & Modalklick-hanterare ---
            statBar.addEventListener('click', (e) => {
                const card = e.target.closest('.stat-card');
                if (card && card.dataset.filter) {
                    currentStatusFilter = card.dataset.filter;
                    renderTimeline();
                    renderGlobalStats(allJobs);
                    filterCalendarView();
                }
            });
            
            jobModalForm.addEventListener('submit', handleFormSubmit);
            fabAddJob.addEventListener('click', () => openJobModal('add'));
            emptyStateAddBtn.addEventListener('click', () => openJobModal('add'));
            
            modalCloseBtn.addEventListener('click', () => closeModal());
            modalCancelBtn.addEventListener('click', () => closeModal());
            customerModalCloseBtn.addEventListener('click', () => closeModal());
            carModalCloseBtn.addEventListener('click', () => closeModal());
            mobileSearchCloseBtn.addEventListener('click', () => closeModal({ popHistory: false })); // PUNKT 7: Ändrad
            settingsModalCloseBtn.addEventListener('click', () => closeModal()); 
            settingsModalCancelBtn.addEventListener('click', () => closeModal()); 
            
            jobModal.addEventListener('click', (e) => { if (e.target === jobModal) closeModal(); });
            customerModal.addEventListener('click', (e) => { if (e.target === customerModal) closeModal(); });
            carModal.addEventListener('click', (e) => { if (e.target === carModal) closeModal(); });
            mobileSearchModal.addEventListener('click', (e) => { if (e.target === mobileSearchModal) closeModal({ popHistory: false }); }); // PUNKT 7: Ändrad
            statsModal.addEventListener('click', (e) => { if (e.target === statsModal) closeModal(); });
            settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeModal(); }); 

            navLogo.addEventListener('click', (e) => {
                e.preventDefault(); 
                openStatsModal();
            });
            
            // --- Inställnings-modal (Vinstmål) ---
            // 1. FUNKTIONEN FÖR ATT ÖPPNA MODALEN
            // Denna funktion läser bara sparade värden och visar dem.
            function openSettingsModal() {
                // Läs in sparat vinstmål och fyll i fältet
                profitGoalInput.value = currentProfitGoal > 0 ? currentProfitGoal : '';
                
                // Läs in sparad standardvy och markera rätt knapp
                const savedView = localStorage.getItem('defaultView') || 'timeline';
                if (savedView === 'calendar') {
                    document.getElementById('defaultViewCalendar').checked = true;
                } else {
                    document.getElementById('defaultViewTimeline').checked = true;
                }
                
                // Hantera visning av mobil-specifika knappar
                if (window.innerWidth <= 768) {
                    mobileSettingsGroup.style.display = 'grid';
                } else {
                    mobileSettingsGroup.style.display = 'none';
                }
                
                // Visa själva modalen
                showModal('settingsModal');
            }

            // 2. DEN NYA LYSSNAREN (LIGGER UTANFÖR)
            // Denna kod körs 1 gång när sidan laddas.
            // Den lyssnar efter klick på radioknapparna och sparar direkt.
            document.querySelectorAll('input[name="defaultView"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    // Om knappen blir "checked"
                    if(e.target.checked) {
                        const selectedView = e.target.value;
                        // Spara valet direkt i localStorage
                        localStorage.setItem('defaultView', selectedView);
                        
                        // Ge visuell feedback på datorn (där "Spara"-knappen inte används för detta)
                        if (window.innerWidth > 768) {
                            showToast('Standardvy sparad!', 'success');
                        }
                    }
                });
            });

            // 3. KOPPLINGAR TILL KNAPPARNA (Dessa rader har du redan, se till att de ligger efter)
            settingsBtn.addEventListener('click', openSettingsModal);
            mobileSettingsBtn.addEventListener('click', openSettingsModal);
            
            settingsModalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                currentProfitGoal = parseFloat(profitGoalInput.value) || 0;
                localStorage.setItem('profitGoal', currentProfitGoal);

				//const selectedView = document.querySelector('input[name="defaultView"]:checked').value;
                //localStorage.setItem('defaultView', selectedView);
				
                showToast('Inställningar sparade!', 'success');
                closeModal();
            });

            settingsThemeToggle.addEventListener('click', () => themeToggle.click());
            settingsToggleCompactView.addEventListener('click', () => toggleCompactView.click());
            settingsLockAppBtn.addEventListener('click', () => {
                closeModal();
                setTimeout(() => lockAppBtn.click(), 250);
            });

            // --- Jobb-mallar (FIXAD) ---
            jobTemplates.addEventListener('click', (e) => {
                const button = e.target.closest('.template-btn');
                if (!button) return;

                const template = button.dataset.template;
                
                if (template === 'oljebyte') {
                    const literOljaprompt = prompt('Hur många liter olja? (t.ex. 4.3)', '4,3');
                    if (literOljaprompt === null) return; 
                    
                    // FIX: Hanterar både komma och punkt som decimal
                    const literOlja = parseFloat(literOljaprompt.replace(',', '.')) || 0;
                    
                    if (literOlja > 0) {
                        const oljekostnad = literOlja * 200; 
                        const filterkostnad = 200; 
                        const arbetskostnad = 500; 
                        
                        modalKundpris.value = Math.round(oljekostnad + filterkostnad + arbetskostnad);
                        modalUtgifter.value = 0; 
                        document.getElementById('kommentarer').value = `Oljebyte:\n- Motorolja (${literOlja}L)\n- Oljefilter`;
                        showToast('Mall tillämpad!', 'info');
                    } else {
                        showToast('Ogiltigt antal liter.', 'danger');
                    }
                    
                } else if (template === 'hjulskifte') {
                    modalKundpris.value = 200;
                    modalUtgifter.value = 0;
                    document.getElementById('kommentarer').value = 'Hjulskifte (sommar/vinter)';
                    showToast('Mall tillämpad!', 'info');
                }
                
                updateLiveProfit();
            });
            
            // --- Klickbara jobblistor i Kund/Bil-modal (FIXAD HISTORIK) ---
            function handleDetailListClick(e) {
                const jobItem = e.target.closest('li[data-job-id]');
                if (!jobItem) return;

                const jobId = jobItem.dataset.jobId;
                const job = findJob(jobId);
                
                if (job) {
                    // FIX: Stäng nuvarande modal, men tryck "bakåt" i historiken
                    if (history.state?.modal) {
                        isNavigatingBack = true;
                        history.back(); // Gå tillbaka från customer/car-modalen
                        isNavigatingBack = false;
                    } else {
                        closeModal({ popHistory: false }); // Fallback
                    }
                    
                    setTimeout(() => {
                        openJobModal('edit', job);
                    }, 50); 
                }
            }
            customerModalJobList.addEventListener('click', handleDetailListClick);
            carModalJobList.addEventListener('click', handleDetailListClick);
            
            // BONUS: Sök i detalj-modalerna
            customerSearch.addEventListener('input', debounce((e) => {
                const kundnamn = customerModalName.textContent;
                const customerJobs = allJobs.filter(j => j.kundnamn === kundnamn).sort((a, b) => new Date(b.datum) - new Date(a.datum));
                renderDetailJobList(customerModalJobList, customerJobs, e.target.value);
            }, 300));

            carSearch.addEventListener('input', debounce((e) => {
                const regnr = carModalRegnr.textContent;
                const carJobs = allJobs.filter(j => j.regnr === regnr).sort((a, b) => new Date(b.datum) - new Date(a.datum));
                renderDetailJobList(carModalJobList, carJobs, e.target.value);
            }, 300));


            // --- Övriga formulär-hanterare ---
            modalKundpris.addEventListener('input', updateLiveProfit);
            modalUtgifter.addEventListener('input', updateLiveProfit);
            
            // NYTT: Funktion för att hitta senaste jobbet
            function findLatestJob(key, value) {
                return [...allJobs].reverse().find(job => job[key] && job[key].toLowerCase() === value.toLowerCase());
            }
            
            // NYTT: Auto-ifyllning från Regnr
            modalRegnr.addEventListener('blur', (e) => {
                const regnr = e.target.value;
                if (regnr.length < 3) return;
                
                const existingJob = findLatestJob('regnr', regnr);
                if (existingJob) {
                    modalKundnamn.value = existingJob.kundnamn.toUpperCase();
                    modalTelefon.value = existingJob.telefon || '';
                    showToast('Kund-data auto-ifylld!', 'info');
                }
            });
            
            modalRegnr.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });

            modalKundnamn.addEventListener('input', () => {
                const query = modalKundnamn.value.toLowerCase();
                kundnamnSuggestions.innerHTML = '';

                if (query.length < 2) {
                    kundnamnSuggestions.style.display = 'none';
                    return;
                }
                const allNames = allJobs.map(job => job.kundnamn);
                const uniqueNames = [...new Set(allNames)];
                const matches = uniqueNames
                    .filter(name => name.toLowerCase().includes(query))
                    .slice(0, 5);

                if (matches.length > 0) {
                    matches.forEach(name => {
                        const item = document.createElement('div');
                        item.classList.add('suggestion-item');
                        item.textContent = name;
                        item.addEventListener('click', () => {
                            modalKundnamn.value = name;
                            kundnamnSuggestions.style.display = 'none';
                            kundnamnSuggestions.innerHTML = '';
                            
                            // NYTT: Auto-ifyll från kundnamn
                            const existingJob = findLatestJob('kundnamn', name);
                            if (existingJob) {
                                modalTelefon.value = existingJob.telefon || '';
                            }
                        });
                        kundnamnSuggestions.appendChild(item);
                    });
                    kundnamnSuggestions.style.display = 'block';
                } else {
                    kundnamnSuggestions.style.display = 'none';
                }
            });
            modalKundnamn.addEventListener('change', () => {
                modalKundnamn.value = modalKundnamn.value.toUpperCase();
            });

            jobModalForm.addEventListener('click', (e) => {
                if (e.target.id !== 'kundnamn') {
                    kundnamnSuggestions.style.display = 'none';
                }
            });
            modalKundnamn.addEventListener('blur', () => {
                setTimeout(() => {
                    kundnamnSuggestions.style.display = 'none';
                }, 150);
            });
            
            quickTimeButtons.addEventListener('click', (e) => {
                if (e.target.dataset.time) {
                    e.preventDefault();
                    modalTid.value = e.target.dataset.time;
                }
            });

            // NYTT: Kopieringsknappar
            async function copyToClipboard(text, fieldName) {
                if (!text) {
                    showToast(`Fältet "${fieldName}" är tomt.`, 'danger');
                    return;
                }
                try {
                    await navigator.clipboard.writeText(text);
                    showToast(`"${fieldName}" kopierad!`, 'success');
                } catch (err) {
                    showToast('Kunde inte kopiera.', 'danger');
                }
            }
            copyKundnamnBtn.addEventListener('click', () => copyToClipboard(modalKundnamn.value, 'Kundnamn'));
            copyRegnrBtn.addEventListener('click', () => copyToClipboard(modalRegnr.value, 'Reg.nr'));

            // --- App-inställningar (Tema, Kompakt, Lås) ---
            themeToggle.addEventListener('click', () => {
                const currentTheme = docElement.getAttribute('data-theme') || 'dark';
                setTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });
            function setTheme(theme) {
                docElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            
            function setCompactMode(isCompact) {
                if (isCompact) {
                    docElement.classList.add('compact-mode');
                    toggleCompactView.classList.add('active');
                    settingsToggleCompactView.classList.add('active'); 
                    localStorage.setItem('compactMode', 'true');
                } else {
                    docElement.classList.remove('compact-mode');
                    toggleCompactView.classList.remove('active');
                    settingsToggleCompactView.classList.remove('active'); 
                    localStorage.setItem('compactMode', 'false');
                }
            }
            toggleCompactView.addEventListener('click', () => {
                const isCompact = !docElement.classList.contains('compact-mode');
                setCompactMode(isCompact);
            });
            settingsToggleCompactView.addEventListener('click', () => { 
                const isCompact = !docElement.classList.contains('compact-mode');
                setCompactMode(isCompact);
            });
            const savedCompactMode = localStorage.getItem('compactMode') !== 'false';
            setCompactMode(savedCompactMode);

            function setupViewToggles() {
                const allToggleButtons = document.querySelectorAll('.button-toggle-view, .mobile-nav-btn[data-view]');
                allToggleButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const view = e.currentTarget.dataset.view;
                        if (view) {
                            toggleView(view);
                        }
                    });
                });
            }
            setupViewToggles();
            
            mobileAddJobBtn.addEventListener('click', () => openJobModal('add'));
            mobileSearchBtn.addEventListener('click', () => {
                showModal('mobileSearchModal');
                mobileSearchBar.focus();
            });
            
            function setHeaderDate() {
                let datePart = new Intl.DateTimeFormat(locale, { weekday: 'short', month: 'short', day: 'numeric' }).format(new Date());
                appBrandTitle.textContent = datePart.charAt(0).toUpperCase() + datePart.slice(1);
            }
            setHeaderDate();


            // --- PIN-lås & Initiering ---
            function showPinLock() {
                appContainer.style.display = 'none';
                fabAddJob.style.display = 'none';
                mobileNav.style.display = 'none';
                
                showModal('pinLockModal');
                pinInput.focus();
            }
            
            function hidePinLock() {
                appContainer.style.display = 'flex';
                fabAddJob.style.display = 'flex';
                if(window.innerWidth <= 768) {
                    mobileNav.style.display = 'flex';
                }
                
                closeModal({ popHistory: false }); 
                localStorage.setItem(PIN_LAST_UNLOCKED_KEY, Date.now().toString());
            }
            
            pinLockForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const storedPin = localStorage.getItem(APP_PIN_KEY);
                const enteredPin = pinInput.value;
                if (enteredPin === storedPin) {
                    pinError.textContent = ''; pinInput.value = '';
                    hidePinLock();
                    if (!appInitialized) {
                        appInitialized = true;
                        initializeCalendar();
                        initRealtimeListener();
						toggleView(currentView);
                    }
                } else {
                    pinError.textContent = 'Fel PIN-kod. Försök igen.';
                    pinLockModal.classList.add('shake-error');
                    pinInput.value = ''; pinInput.focus();
                    setTimeout(() => pinLockModal.classList.remove('shake-error'), 500);
                }
            });
            lockAppBtn.addEventListener('click', () => {
            	localStorage.removeItem(PIN_LAST_UNLOCKED_KEY);
                showPinLock();
                showToast('Appen är nu låst.', 'info');
            });
            
            document.addEventListener('keydown', (e) => {
                if (currentOpenModalId === 'pinLockModal' && e.key === 'Escape') {
                    e.preventDefault();
                    return;
                }

                if (e.key === 'Escape') {
                    if (isModalOpen) {
                        e.preventDefault();
                        // PUNKT 7: Hantera escape för mobil-sök
                        if (currentOpenModalId === 'mobileSearchModal') {
                            closeModal({ popHistory: false });
                        } else {
                            closeModal(); 
                        }
                    } else if (commentPopover.classList.contains('show')) {
                        e.preventDefault();
                        hideCommentPopover();
                    } else {
                        hideContextMenu();
                    }
                    return;
                }
                
                const isInputFocused = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'SELECT';
                
                if (isModalOpen && e.key === 'Enter' && document.activeElement.tagName !== 'TEXTAREA') {
                    if (currentOpenModalId === 'jobModal') {
                        e.preventDefault();
                        modalSaveBtn.click();
                    } else if (currentOpenModalId === 'settingsModal') {
                        e.preventDefault();
                        settingsModalSaveBtn.click();
                    }
                }

                if (isModalOpen || isInputFocused || contextMenu.classList.contains('show')) return;
                
                switch(e.key.toLowerCase()) {
                    case 'n': e.preventDefault(); openJobModal('add'); break;
                    case 'f': 
                        e.preventDefault(); 
                        if (window.innerWidth <= 768) {
                            mobileSearchBtn.click();
                        } else {
                            searchBar.focus();
                        }
                        break;
                }
            });

            // --- NYTT: CSV-Export ---
            function exportToCsv(data) {
                const headers = [
                    "ID", "Status", "Datum", "Tid", "Kundnamn", "Telefon", 
                    "Regnr", "Mätarställning", "Kundpris", "Utgifter", "Vinst", 
                    "Prioritet", "Kommentarer"
                ];
                
                const rows = data.map(job => {
                    const d = new Date(job.datum);
                    const date = d.toISOString().split('T')[0];
                    const time = d.toTimeString().substring(0, 5);
                    
                    const row = [
                        job.id,
                        STATUS_TEXT[job.status] || job.status,
                        date,
                        time,
                        job.kundnamn,
                        job.telefon || '',
                        job.regnr || '',
                        job.matarstallning || '',
                        job.kundpris || 0,
                        job.utgifter || 0,
                        job.vinst || 0,
                        job.prio ? 'Ja' : 'Nej',
                        (job.kommentarer || '').replace(/"/g, '""').replace(/\n/g, ' ')
                    ];
                    return `"${row.join('","')}"`;
                });

                const csvContent = "data:text/csv;charset=utf-8," 
                    + `"${headers.join('","')}"\n` 
                    + rows.join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `jobb_export_${todayString}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('CSV-fil exporterad!', 'success');
            }
            
            exportCsvBtn.addEventListener('click', () => {
                if (allJobs.length > 0) {
                    exportToCsv(allJobs);
                } else {
                    showToast('Det finns inga jobb att exportera.', 'danger');
                }
            });
         
            const storedPin = localStorage.getItem(APP_PIN_KEY);
            const lastUnlockedTimestamp = localStorage.getItem(PIN_LAST_UNLOCKED_KEY);
            let isUnlocked = false; 

            if (lastUnlockedTimestamp) {
                const lastUnlocked = parseInt(lastUnlockedTimestamp, 10);
                const elapsedHours = (Date.now() - lastUnlocked) / (1000 * 60 * 60);
                
                if (elapsedHours <= 1) {
                    isUnlocked = true;
                } else {
                    localStorage.removeItem(PIN_LAST_UNLOCKED_KEY);
                }
            }
            
            if (storedPin) {
                if (isUnlocked) {
                    appInitialized = true;
                    initializeCalendar();
                    initRealtimeListener();
					toggleView(currentView);
                } else {
                    showPinLock();
                }
            } else {
                localStorage.setItem(APP_PIN_KEY, '0912');
                localStorage.setItem(PIN_LAST_UNLOCKED_KEY, Date.now().toString());
                //showToast('Standard PIN "0912" har ställts in.', 'info');
                appInitialized = true;
                initializeCalendar();
                initRealtimeListener();
				toggleView(currentView);
            }
            
            window.addEventListener('resize', debounce(() => {
                renderTimeline();
                if (calendar && currentView === 'calendar') {
                    calendar.rerenderEvents();
                    updateDailyProfitInCalendar(allJobs);
                }
            }, 200));

        });
    </script>

</body>
</html>
